<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Dashboard - PDF & CSV Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, system-ui, 'Helvetica Neue', Arial, sans-serif;
            background: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            transition: background-color 0.2s, color 0.2s;
        }
        
        /* VS Code Theme Variables */
        :root {
            --vscode-editor-background: #1e1e1e;
            --vscode-editor-foreground: #d4d4d4;
            --vscode-sidebar-background: #252526;
            --vscode-panel-background: #2d2d30;
            --vscode-input-background: #3c3c3c;
            --vscode-button-background: #0e639c;
            --vscode-button-hover-background: #1177bb;
            --vscode-border-color: #3c3c3c;
            --vscode-text-link-foreground: #4fc1ff;
            --vscode-list-active-background: #094771;
            --vscode-list-hover-background: #2a2d2e;
            --vscode-success-foreground: #89d185;
            --vscode-error-foreground: #f85149;
            --vscode-warning-foreground: #ffab70;
            --vscode-card-background: #252526;
            --vscode-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        :root[data-theme="light"] {
            --vscode-editor-background: #ffffff;
            --vscode-editor-foreground: #24292f;
            --vscode-sidebar-background: #f6f8fa;
            --vscode-panel-background: #f6f8fa;
            --vscode-input-background: #ffffff;
            --vscode-button-background: #0969da;
            --vscode-button-hover-background: #0550ae;
            --vscode-border-color: #d1d9e0;
            --vscode-text-link-foreground: #0969da;
            --vscode-list-active-background: #dbeafe;
            --vscode-list-hover-background: #f3f4f6;
            --vscode-success-foreground: #1a7f37;
            --vscode-error-foreground: #d1242f;
            --vscode-warning-foreground: #bf8700;
            --vscode-card-background: #ffffff;
            --vscode-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        }

        :root[data-theme="dark"] {
            --vscode-editor-background: #1e1e1e;
            --vscode-editor-foreground: #d4d4d4;
            --vscode-sidebar-background: #252526;
            --vscode-panel-background: #2d2d30;
            --vscode-input-background: #3c3c3c;
            --vscode-button-background: #0e639c;
            --vscode-button-hover-background: #1177bb;
            --vscode-border-color: #3c3c3c;
            --vscode-text-link-foreground: #4fc1ff;
            --vscode-list-active-background: #094771;
            --vscode-list-hover-background: #2a2d2e;
            --vscode-success-foreground: #89d185;
            --vscode-error-foreground: #f85149;
            --vscode-warning-foreground: #ffab70;
            --vscode-card-background: #252526;
            --vscode-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--vscode-panel-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--vscode-shadow);
            position: relative;
        }

        .header h1 {
            color: var(--vscode-editor-foreground);
            margin-bottom: 12px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .header p {
            color: var(--vscode-editor-foreground);
            opacity: 0.8;
            font-size: 1.05em;
            font-weight: 400;
        }

        .header-badges {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            gap: 16px;
        }
        
        .privacy-badge {
            display: inline-flex;
            align-items: center;
            background: var(--vscode-success-foreground);
            color: var(--vscode-editor-background);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .theme-toggle {
            background: var(--vscode-button-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            position: relative;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle:hover {
            background: var(--vscode-button-hover-background);
        }
        
        .theme-icon {
            width: 18px;
            height: 18px;
            position: absolute;
            transition: opacity 0.2s;
        }
        
        /* Default dark theme icons */
        :root .sun-icon {
            opacity: 1;
        }
        
        :root .moon-icon {
            opacity: 0;
        }
        
        :root[data-theme="dark"] .sun-icon {
            opacity: 1;
        }
        
        :root[data-theme="dark"] .moon-icon {
            opacity: 0;
        }
        
        :root[data-theme="light"] .sun-icon {
            opacity: 0;
        }
        
        :root[data-theme="light"] .moon-icon {
            opacity: 1;
        }

        .privacy-badge svg {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .upload-section {
            background: var(--vscode-panel-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--vscode-shadow);
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--vscode-border-color);
            border-radius: 6px;
            padding: 48px 32px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--vscode-input-background);
        }

        .upload-area:hover {
            border-color: var(--vscode-text-link-foreground);
            background: var(--vscode-list-hover-background);
        }

        .upload-area.dragover {
            border-color: var(--vscode-text-link-foreground);
            background: var(--vscode-list-active-background);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--vscode-button-background);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
        }

        input[type="file"] {
            display: none;
        }

        .format-badges {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .format-badge {
            padding: 4px 8px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            font-size: 0.8em;
            color: var(--vscode-editor-foreground);
            font-weight: 500;
        }

        .format-badge.pdf {
            background: var(--vscode-error-foreground);
            color: var(--vscode-editor-background);
        }

        .format-badge.csv {
            background: var(--vscode-success-foreground);
            color: var(--vscode-editor-background);
        }

        .sample-data-btn {
            margin-top: 16px;
            padding: 10px 16px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            color: var(--vscode-editor-foreground);
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            font-family: inherit;
        }

        .sample-data-btn:hover {
            background: var(--vscode-list-hover-background);
            border-color: var(--vscode-text-link-foreground);
        }

        .dashboard {
            display: none;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .dashboard.active {
            display: grid;
        }

        .card {
            background: var(--vscode-card-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 20px;
            box-shadow: var(--vscode-shadow);
        }

        .card h2 {
            color: var(--vscode-editor-foreground);
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h2 svg {
            width: 24px;
            height: 24px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--vscode-button-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 16px;
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-change {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transactions-table th {
            background: var(--vscode-panel-background);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--vscode-editor-foreground);
            border-bottom: 1px solid var(--vscode-border-color);
            font-size: 0.9em;
        }

        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid var(--vscode-border-color);
            color: var(--vscode-editor-foreground);
            font-size: 0.85em;
        }

        .transactions-table tr:hover {
            background: var(--vscode-list-hover-background);
        }

        .amount-positive {
            color: var(--vscode-success-foreground);
            font-weight: 600;
        }

        .amount-negative {
            color: var(--vscode-error-foreground);
            font-weight: 600;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 6px 8px;
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            font-size: 0.85em;
            background: var(--vscode-input-background);
            color: var(--vscode-editor-foreground);
            font-family: inherit;
        }

        .budget-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .budget-label {
            flex: 1;
            font-size: 0.85em;
            color: var(--vscode-editor-foreground);
        }

        .budget-bar {
            flex: 2;
            height: 24px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin: 0 12px;
        }

        .budget-fill {
            height: 100%;
            background: var(--vscode-text-link-foreground);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.8em;
            font-weight: 500;
        }

        .budget-amount {
            font-size: 0.8em;
            color: var(--vscode-editor-foreground);
            font-weight: 500;
            min-width: 100px;
            text-align: right;
        }

        .insights-list {
            list-style: none;
        }

        .insights-list li {
            padding: 12px;
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid var(--vscode-text-link-foreground);
            color: var(--vscode-editor-foreground);
            font-size: 0.85em;
            line-height: 1.5;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: white;
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-family: inherit;
            font-weight: 500;
        }

        .export-btn:hover {
            background: var(--vscode-button-hover-background);
            transform: translateY(-1px);
        }

        /* Analysis Controls Styles */
        .analysis-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            min-width: 100px;
            color: var(--vscode-editor-foreground);
        }

        .date-input, .search-input {
            padding: 6px 10px;
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            background: var(--vscode-input-background);
            color: var(--vscode-editor-foreground);
            font-family: inherit;
        }

        .control-btn, .filter-btn {
            padding: 6px 12px;
            background: var(--vscode-button-background);
            color: white;
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-family: inherit;
        }

        .control-btn:hover, .filter-btn:hover {
            background: var(--vscode-button-hover-background);
        }

        .filter-btn {
            background: var(--vscode-panel-background);
            color: var(--vscode-editor-foreground);
        }

        .filter-btn:hover {
            background: var(--vscode-list-hover-background);
        }

        .filter-btn.active {
            background: var(--vscode-list-active-background);
            color: white;
        }

        /* Document Analysis Grid */
        .document-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .doc-analysis-card {
            background: var(--vscode-sidebar-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 15px;
        }

        .doc-analysis-card h4 {
            margin: 0 0 10px 0;
            color: var(--vscode-text-link-foreground);
        }

        .analysis-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .analysis-metric .label {
            color: var(--vscode-editor-foreground);
        }

        .analysis-metric .value {
            font-weight: 600;
            color: var(--vscode-text-link-foreground);
        }

        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .insight-card {
            background: var(--vscode-sidebar-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            padding: 15px;
        }

        .insight-card h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .insight-card.warning {
            border-left: 4px solid var(--vscode-warning-foreground);
        }

        .insight-card.error {
            border-left: 4px solid var(--vscode-error-foreground);
        }

        .insight-card.success {
            border-left: 4px solid var(--vscode-success-foreground);
        }

        .insight-card.info {
            border-left: 4px solid var(--vscode-text-link-foreground);
        }

        .count-badge {
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--vscode-sidebar-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: var(--vscode-editor-foreground);
            font-size: 0.9em;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 6px 12px;
            background: var(--vscode-button-background);
            color: white;
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--vscode-button-hover-background);
        }

        .pagination-btn:disabled {
            background: var(--vscode-panel-background);
            color: var(--vscode-descriptionForeground);
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            gap: 4px;
            margin: 0 10px;
        }

        .page-number {
            padding: 6px 10px;
            background: var(--vscode-panel-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--vscode-editor-foreground);
            transition: all 0.2s;
        }

        .page-number:hover {
            background: var(--vscode-list-hover-background);
        }

        .page-number.active {
            background: var(--vscode-list-active-background);
            color: white;
        }

        .pagination-size {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-size label {
            color: var(--vscode-editor-foreground);
            font-size: 0.9em;
        }

        .pagination-size select {
            padding: 4px 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-editor-foreground);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            font-size: 0.85em;
        }

        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .document-item {
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            padding: 12px;
            border-left: 3px solid var(--vscode-text-link-foreground);
            position: relative;
        }

        .document-item.active {
            background: var(--vscode-list-active-background);
            border-left-color: var(--vscode-text-link-foreground);
            border-color: var(--vscode-text-link-foreground);
        }

        .document-name {
            font-weight: 600;
            color: var(--vscode-editor-foreground);
            margin-bottom: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .document-stats {
            font-size: 0.75em;
            color: var(--vscode-editor-foreground);
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .document-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .document-btn.view {
            background: var(--vscode-button-background);
            color: white;
        }

        .document-btn.view:hover {
            background: var(--vscode-button-hover-background);
        }

        .document-btn.remove {
            background: var(--vscode-error-foreground);
            color: white;
        }

        .document-btn.remove:hover {
            background: var(--vscode-error-foreground);
            opacity: 0.8;
        }

        .processing-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--vscode-panel-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            border-left: 3px solid var(--vscode-text-link-foreground);
        }

        .processing-progress {
            flex: 1;
            height: 6px;
            background: var(--vscode-input-background);
            border-radius: 3px;
            overflow: hidden;
        }

        .processing-progress-bar {
            height: 100%;
            background: var(--vscode-text-link-foreground);
            transition: width 0.3s;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 32px;
            background: var(--vscode-panel-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 6px;
            margin-bottom: 24px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--vscode-border-color);
            border-top-color: var(--vscode-text-link-foreground);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .half-width {
            grid-column: span 1;
        }

        .extraction-preview {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .extraction-preview h3 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .extraction-preview pre {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #4b5563;
            white-space: pre-wrap;
        }

        .account-info {
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .account-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .account-info-label {
            color: var(--vscode-editor-foreground);
            opacity: 0.7;
        }

        .account-info-value {
            color: var(--vscode-editor-foreground);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .half-width {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’° Personal Finance Dashboard</h1>
            <p>Analyze bank statements from PDFs or CSVs - Extract, visualize, and gain insights</p>
            <div class="header-badges">
                <div class="privacy-badge">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    100% Private - No data leaves your device
                </div>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <svg class="theme-icon sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg class="theme-icon moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <h3 style="color: var(--vscode-editor-foreground); margin-bottom: 10px; font-weight: 600;">Drop your bank statements here</h3>
                <p style="color: var(--vscode-editor-foreground); opacity: 0.7; margin-bottom: 20px;">Support multiple files - or click to browse</p>
                <div class="format-badges">
                    <span class="format-badge pdf">PDF Statements</span>
                    <span class="format-badge csv">CSV Exports</span>
                </div>
                <p style="color: var(--vscode-editor-foreground); opacity: 0.6; font-size: 0.8em; margin-top: 15px;">
                    Supports: HSBC, Commonwealth Bank, ANZ, Westpac, NAB, and most major banks
                </p>
                <input type="file" id="fileInput" accept=".pdf,.csv" multiple>
            </div>
            <button class="sample-data-btn" onclick="loadSampleData()">Load Sample Data to Try It Out</button>
            <div id="extractionPreview" class="extraction-preview" style="display: none;">
                <h3>ðŸ“„ Extracted Data Preview</h3>
                <pre id="extractionContent"></pre>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--vscode-editor-foreground); font-size: 1em; opacity: 0.9;">Extracting and analyzing your financial data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Document Management -->
            <div class="card full-width" id="documentManager" style="display: none;">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Uploaded Documents (<span id="documentCount">0</span>)
                </h2>
                <div id="documentList" class="document-list"></div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="clearAllDocuments()">Clear All</button>
                    <button class="export-btn" onclick="addMoreDocuments()">Add More Files</button>
                </div>
            </div>
            
            <!-- Account Information -->
            <div class="card full-width" id="accountInfoCard" style="display: none;">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    Account Information
                </h2>
                <div class="account-info" id="accountInfo"></div>
            </div>

            <!-- Summary Stats -->
            <div class="stat-grid full-width">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" id="totalIncome">$0</div>
                    <div class="stat-change" id="incomeChange">+0% from last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value" id="totalExpenses">$0</div>
                    <div class="stat-change" id="expenseChange">+0% from last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Savings</div>
                    <div class="stat-value" id="netSavings">$0</div>
                    <div class="stat-change" id="savingsRate">0% savings rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Balance</div>
                    <div class="stat-value" id="currentBalance">$0</div>
                    <div class="stat-change" id="balanceChange">+$0 this month</div>
                </div>
            </div>

            <!-- Spending by Category -->
            <div class="card">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Spending by Category
                </h2>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Monthly Trend -->
            <div class="card">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    Monthly Trend
                </h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Budget Tracking -->
            <div class="card full-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Budget vs Actual
                </h2>
                <div id="budgetContainer"></div>
            </div>

            <!-- Smart Insights -->
            <div class="card half-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Smart Insights
                </h2>
                <ul class="insights-list" id="insightsList"></ul>
            </div>

            <!-- Daily Spending -->
            <div class="card half-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Daily Spending Pattern
                </h2>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Enhanced Analysis Dashboard -->
            <div class="card full-width" id="analysisToolbar" style="display: none;">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; display: inline; vertical-align: text-bottom; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Ad-hoc Analysis Tools
                </h3>
                <div class="analysis-controls">
                    <div class="control-group">
                        <label>Date Range:</label>
                        <input type="date" id="analysisStartDate" class="date-input">
                        <input type="date" id="analysisEndDate" class="date-input">
                        <button class="control-btn" onclick="applyDateFilter()">Apply</button>
                    </div>
                    <div class="control-group">
                        <label>Quick Filters:</label>
                        <button class="filter-btn" onclick="findDuplicates()">Find Duplicates</button>
                        <button class="filter-btn" onclick="findTransfers()">Find Transfers</button>
                        <button class="filter-btn" onclick="findAnomalies()">Find Anomalies</button>
                        <button class="filter-btn" onclick="analyzeFrequency()">Frequency Analysis</button>
                    </div>
                    <div class="control-group">
                        <label>Search:</label>
                        <input type="text" id="transactionSearch" placeholder="Search transactions (regex supported)" class="search-input">
                        <button class="control-btn" onclick="searchTransactions()">Search</button>
                        <button class="control-btn" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Document Intelligence Panel -->
            <div class="card full-width" id="documentIntelligence" style="display: none;">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; display: inline; vertical-align: text-bottom; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Document Intelligence
                </h3>
                <div id="documentAnalysis" class="document-analysis-grid"></div>
            </div>

            <!-- Advanced Insights Panel -->
            <div class="card full-width" id="advancedInsights" style="display: none;">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; display: inline; vertical-align: text-bottom; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Advanced Insights
                </h3>
                <div id="advancedInsightsList" class="insights-grid"></div>
            </div>

            <!-- Recent Transactions -->
            <div class="card full-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Recent Transactions
                </h2>
                <div class="filter-controls">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expenses</option>
                    </select>
                    <input type="date" id="startDate" placeholder="Start Date">
                    <input type="date" id="endDate" placeholder="End Date">
                </div>
                <div style="overflow-x: auto;">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Balance</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination-controls" id="paginationControls" style="display: none;">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 0-0 of 0 transactions</span>
                    </div>
                    <div class="pagination-buttons">
                        <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">First</button>
                        <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">Previous</button>
                        <span class="pagination-pages" id="pageNumbers"></span>
                        <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">Next</button>
                        <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(totalPages)">Last</button>
                    </div>
                    <div class="pagination-size">
                        <label>Items per page:</label>
                        <select id="pageSize" onchange="changePageSize()">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                    <button class="export-btn" onclick="generateEnhancedReport()">Enhanced Report</button>
                    <button class="export-btn" onclick="generateTaxReport()">Tax Summary</button>
                    <button class="export-btn" onclick="showAllDocuments()">Show All Documents</button>
                    <button class="export-btn" onclick="clearSession()">Clear Session</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let transactions = [];
        let categories = {};
        let monthlyData = {};
        let budgets = {};
        let accountDetails = {};
        let uploadedDocuments = [];
        let currentDocumentIndex = 0;

        // Enhanced category detection patterns
        const categoryPatterns = {
            'Groceries': ['grocery', 'supermarket', 'walmart', 'target', 'kroger', 'safeway', 'whole foods', 'trader joe', 'woolworth', 'coles', 'aldi', 'iga', '7-eleven'],
            'Dining': ['restaurant', 'cafe', 'coffee', 'starbucks', 'mcdonalds', 'chipotle', 'pizza', 'bar', 'pub', 'sushi', 'nandos', 'hungry jack', 'oporto', 'gong cha', 'doordash', 'uber *eat', 'menulog', 'enzos', 'cucina', 'dd *doordash', 'desilicio'],
            'Transportation': ['uber', 'lyft', 'gas', 'shell', 'chevron', 'parking', 'toll', 'transit', 'metro', 'ampol', 'mobil', 'petrol', 'fuel', 'uber *trip'],
            'Shopping': ['amazon', 'ebay', 'store', 'mall', 'clothing', 'shoes', 'fashion', 'kmart', 'target', 'bunnings', 'costco', 'amazon au'],
            'Entertainment': ['netflix', 'spotify', 'movie', 'theater', 'concert', 'game', 'sport', 'audible', 'apple.com/bill', 'google youtube', 'audible limited'],
            'Utilities': ['electric', 'gas', 'water', 'internet', 'phone', 'verizon', 'att', 'comcast', 'telstra', 'optus', 'vodafone'],
            'Healthcare': ['pharmacy', 'doctor', 'hospital', 'dental', 'medical', 'cvs', 'walgreens', 'bupa', 'medicare', 'health', 'resmed'],
            'Housing': ['rent', 'mortgage', 'property', 'lease', 'apartment', 'real estate'],
            'Insurance': ['insurance', 'geico', 'allstate', 'progressive', 'suncorp', 'aami', 'nrma'],
            'Travel': ['hotel', 'booking.com', 'airbnb', 'flight', 'airline', 'expedia', 'holiday', 'bkg*booking.com', 'overseas trans chg'],
            'Subscriptions': ['subscription', 'membership', 'resmed', 'patreon', 'onlyfans'],
            'Income': ['salary', 'payroll', 'deposit', 'transfer', 'income', 'payment received', 'wages', 'refund'],
            'PayPal': ['paypal', 'pypl', 'paypal *pypl'],
            'Savings': ['savings', 'investment', '401k', 'ira', 'transfer to savings']
        };

        // Category colors
        const categoryColors = {
            'Groceries': '#10b981',
            'Dining': '#f59e0b',
            'Transportation': '#3b82f6',
            'Shopping': '#ec4899',
            'Entertainment': '#8b5cf6',
            'Utilities': '#6b7280',
            'Healthcare': '#ef4444',
            'Housing': '#14b8a6',
            'Insurance': '#f97316',
            'Travel': '#06b6d4',
            'Subscriptions': '#a855f7',
            'Income': '#22c55e',
            'PayPal': '#0070ba',
            'Savings': '#06b6d4',
            'Other': '#9ca3af'
        };

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                processMultipleFiles(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                processMultipleFiles(files);
            }
        });

        async function processMultipleFiles(files) {
            document.getElementById('loading').classList.add('active');
            
            // Clear existing data if this is the first upload
            if (uploadedDocuments.length === 0) {
                transactions = [];
                categories = {};
                monthlyData = {};
                budgets = {};
                accountDetails = {};
            }
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            // Show processing status
            showProcessingStatus(totalFiles);
            
            for (const file of files) {
                try {
                    const documentData = {
                        name: file.name,
                        size: file.size,
                        type: file.name.endsWith('.pdf') ? 'PDF' : 'CSV',
                        uploadDate: new Date(),
                        transactions: [],
                        accountDetails: {},
                        processed: false
                    };
                    
                    if (file.name.endsWith('.pdf')) {
                        await processPDFForDocument(file, documentData);
                    } else if (file.name.endsWith('.csv')) {
                        await processCSVForDocument(file, documentData);
                    }
                    
                    uploadedDocuments.push(documentData);
                    processedCount++;
                    updateProcessingProgress(processedCount, totalFiles);
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    alert(`Error processing ${file.name}. Skipping this file.`);
                }
            }
            
            // Combine all document data
            combineDocumentData();
            
            // Hide loading and show dashboard
            setTimeout(() => {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('documentManager').style.display = 'block';
                
                // Start with combined view if multiple documents, otherwise show the single document
                if (uploadedDocuments.length > 1) {
                    currentDocumentIndex = -1;
                    combineDocumentData();
                } else {
                    currentDocumentIndex = 0;
                }
                updateDocumentManager();
            }, 1000);
        }
        
        async function processFile(file) {
            // Legacy function for backward compatibility
            await processMultipleFiles([file]);
        }

        async function processPDFForDocument(file, documentData) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                // Extract text from all pages with better line separation
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // Group text items by vertical position to preserve lines
                    const lineGroups = {};
                    textContent.items.forEach(item => {
                        const y = Math.round(item.transform[5]); // Y coordinate
                        if (!lineGroups[y]) lineGroups[y] = [];
                        lineGroups[y].push(item);
                    });
                    
                    // Sort lines by Y position (top to bottom)
                    const sortedLines = Object.keys(lineGroups)
                        .sort((a, b) => b - a) // Higher Y values first (top to bottom)
                        .map(y => lineGroups[y]);
                    
                    // Reconstruct text with proper line breaks
                    const pageText = sortedLines.map(lineItems => {
                        // Sort items in each line by X position (left to right)
                        lineItems.sort((a, b) => a.transform[4] - b.transform[4]);
                        return lineItems.map(item => item.str).join(' ');
                    }).join('\n');
                    
                    fullText += pageText + '\n';
                }
                
                // Show extraction preview
                const preview = document.getElementById('extractionPreview');
                const content = document.getElementById('extractionContent');
                preview.style.display = 'block';
                content.textContent = fullText.substring(0, 1000) + '...';
                
                // Parse the extracted text for this document
                parsePDFTextForDocument(fullText, documentData);
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('Error processing PDF. Please try a different file.');
                document.getElementById('loading').classList.remove('active');
            }
        }

        function parsePDFTextForDocument(text, documentData) {
            const docTransactions = [];
            const docAccountDetails = {};
            
            // Extract account details (for HSBC format)
            const accountMatch = text.match(/Account Number.*?(\d{4}\s+\d{4}\s+\d{4}\s+\d{4})/);
            const creditLimitMatch = text.match(/Credit Limit\s+\$?([\d,]+\.?\d*)/);
            const closingBalanceMatch = text.match(/Closing Balance\s+\$?([\d,]+\.?\d*)/);
            const openingBalanceMatch = text.match(/Opening Balance\s+\$?([\d,]+\.?\d*)/);
            
            if (accountMatch) {
                docAccountDetails.accountNumber = accountMatch[1].replace(/\s+/g, ' ');
            }
            if (creditLimitMatch) {
                docAccountDetails.creditLimit = parseFloat(creditLimitMatch[1].replace(/,/g, ''));
            }
            if (closingBalanceMatch) {
                docAccountDetails.closingBalance = parseFloat(closingBalanceMatch[1].replace(/,/g, ''));
            }
            if (openingBalanceMatch) {
                docAccountDetails.openingBalance = parseFloat(openingBalanceMatch[1].replace(/,/g, ''));
            }
            
            // Parse transactions - looking for date patterns and amounts
            const lines = text.split('\n');
            
            // Enhanced patterns for different statement formats
            // HSBC Credit Card: "DD/MM/YY NNNN MERCHANT_NAME $AMOUNT"
            const hsbcPattern = /(\d{2}\/\d{2}\/\d{2})\s+(\d{4})\s+(.+?)\s+(-?\$[\d,]+\.\d{2})$/;
            
            // HSBC Alternative: "DD/MM/YY DESCRIPTION $AMOUNT" (no card number)
            const hsbcAltPattern = /(\d{2}\/\d{2}\/\d{2})\s+([^0-9].+?)\s+(-?\$[\d,]+\.\d{2})$/;
            
            // Generic patterns for other banks
            const transactionPattern = /(\d{1,2}\/\d{2}\/\d{2,4})\s+(\d{4})?\s*(.*?)\s+(-?\$?[\d,]+\.?\d*)/;
            const altPattern = /(\d{1,2}\/\d{2}\/\d{2})\s+(.*?)\s+\$?([\d,]+\.\d{2})/;
            
            lines.forEach((line, index) => {
                if (line.length < 10) return;
                
                // First, check if this line contains multiple transactions by looking for multiple date patterns
                const multipleTransactionSplits = splitMultipleTransactions(line);
                
                if (multipleTransactionSplits.length > 1) {
                    // Process each split transaction separately
                    multipleTransactionSplits.forEach(transactionLine => {
                        processTransactionLine(transactionLine, docTransactions);
                    });
                } else {
                    // Process single transaction line normally
                    processTransactionLine(line, docTransactions);
                }
            });
            
            // Helper function to split lines with multiple transactions
            function splitMultipleTransactions(line) {
                // Look for multiple date patterns in the same line
                const datePattern = /\d{2}\/\d{2}\/\d{2}/g;
                const matches = [...line.matchAll(datePattern)];
                
                if (matches.length <= 1) {
                    return [line]; // Single or no transaction
                }
                
                // Split the line at each date occurrence (except the first)
                const splits = [];
                let lastIndex = 0;
                
                matches.forEach((match, i) => {
                    if (i > 0) {
                        // Add the previous transaction (from lastIndex to current match)
                        splits.push(line.substring(lastIndex, match.index).trim());
                        lastIndex = match.index;
                    }
                });
                
                // Add the last transaction
                splits.push(line.substring(lastIndex).trim());
                
                return splits.filter(split => split.length > 10); // Filter out empty or very short splits
            }
            
            // Helper function to process a single transaction line
            function processTransactionLine(line, docTransactions) {
                let match = null;
                let description = '';
                let amountStr = '';
                let dateStr = '';
                
                // Try HSBC patterns first
                match = line.match(hsbcPattern);
                if (match) {
                    dateStr = match[1];
                    description = match[3].trim(); // Skip card number, use merchant name
                    amountStr = match[4];
                } else {
                    // Try HSBC alternative pattern (no card number)
                    match = line.match(hsbcAltPattern);
                    if (match) {
                        dateStr = match[1];
                        description = match[2].trim();
                        amountStr = match[3];
                    } else {
                        // Try generic patterns
                        match = line.match(transactionPattern);
                        if (!match) {
                            match = line.match(altPattern);
                        }
                        
                        if (match) {
                            dateStr = match[1];
                            if (match.length === 5) {
                                description = match[3].trim();
                                amountStr = match[4];
                            } else {
                                description = match[2].trim();
                                amountStr = match[3];
                            }
                        }
                    }
                }
                
                if (match && dateStr && description && amountStr) {
                    // Clean up amount string - handle negative amounts properly
                    let amount = parseFloat(amountStr.replace(/[$,]/g, ''));
                    
                    // Handle negative amounts (refunds/credits) - they often start with -
                    if (amountStr.includes('-')) {
                        amount = -Math.abs(amount);
                    }
                    
                    if (!isNaN(amount) && description.length > 0) {
                        const dateParts = dateStr.split('/');
                        let date;
                        if (dateParts[2].length === 2) {
                            date = new Date(`20${dateParts[2]}`, parseInt(dateParts[1]) - 1, dateParts[0]);
                        } else {
                            date = new Date(dateParts[2], parseInt(dateParts[1]) - 1, dateParts[0]);
                        }
                        
                        const category = detectCategory(description);
                        const isRefund = description.toLowerCase().includes('refund') || 
                                       description.toLowerCase().includes('credit') ||
                                       amountStr.includes('-');
                        
                        // For credit card statements: 
                        // - Regular purchases are expenses (positive amounts in statement, negative in our system)
                        // - Refunds/credits are income (negative amounts in statement, positive in our system)
                        let finalAmount;
                        let type;
                        
                        if (isRefund) {
                            finalAmount = Math.abs(amount); // Refunds are positive income
                            type = 'income';
                        } else {
                            finalAmount = -Math.abs(amount); // Expenses are negative
                            type = 'expense';
                        }
                        
                        const transaction = {
                            date,
                            description: description.substring(0, 80), // Increased length for HSBC merchant names
                            amount: finalAmount,
                            balance: 0,
                            category,
                            type,
                            month: date.toISOString().substring(0, 7),
                            sourceDocument: documentData.name
                        };
                        
                        docTransactions.push(transaction);
                    }
                }
            }
            
            });
            
            // Sort transactions by date
            docTransactions.sort((a, b) => b.date - a.date);
            
            // Calculate running balance
            if (docAccountDetails.closingBalance) {
                let runningBalance = docAccountDetails.closingBalance;
                for (let i = 0; i < docTransactions.length; i++) {
                    docTransactions[i].balance = runningBalance;
                    runningBalance -= docTransactions[i].amount;
                }
            }
            
            documentData.transactions = docTransactions;
            documentData.accountDetails = docAccountDetails;
            documentData.processed = true;
        }
        
        function parsePDFText(text) {
            // This function is kept for backward compatibility
            const tempDocData = { transactions: [], accountDetails: {} };
            parsePDFTextForDocument(text, tempDocData);
            
            transactions = tempDocData.transactions;
            accountDetails = tempDocData.accountDetails;
            categories = {};
            monthlyData = {};
            
            // Extract account details (for HSBC format)
            const accountMatch = text.match(/Account Number.*?(\d{4}\s+\d{4}\s+\d{4}\s+\d{4})/);
            const creditLimitMatch = text.match(/Credit Limit\s+\$?([\d,]+\.?\d*)/);
            const closingBalanceMatch = text.match(/Closing Balance\s+\$?([\d,]+\.?\d*)/);
            const openingBalanceMatch = text.match(/Opening Balance\s+\$?([\d,]+\.?\d*)/);
            
            if (accountMatch) {
                accountDetails.accountNumber = accountMatch[1].replace(/\s+/g, ' ');
            }
            if (creditLimitMatch) {
                accountDetails.creditLimit = parseFloat(creditLimitMatch[1].replace(/,/g, ''));
            }
            if (closingBalanceMatch) {
                accountDetails.closingBalance = parseFloat(closingBalanceMatch[1].replace(/,/g, ''));
            }
            if (openingBalanceMatch) {
                accountDetails.openingBalance = parseFloat(openingBalanceMatch[1].replace(/,/g, ''));
            }
            
            // Update account info display
            if (Object.keys(accountDetails).length > 0) {
                updateAccountInfo();
            }
            
            // Parse transactions - looking for date patterns and amounts
            // Common patterns: DD/MM/YY or DD/MM/YYYY followed by description and amount
            const lines = text.split('\n');
            const transactionPattern = /(\d{1,2}\/\d{2}\/\d{2,4})\s+(\d{4})?\s*(.*?)\s+(-?\$?[\d,]+\.?\d*)/;
            
            // Also check for transactions in a different format
            const altPattern = /(\d{1,2}\/\d{2}\/\d{2})\s+(.*?)\s+\$?([\d,]+\.\d{2})/;
            
            lines.forEach((line, index) => {
                // Skip header lines and empty lines
                if (line.length < 10) return;
                
                // Try to match transaction patterns
                let match = line.match(transactionPattern);
                if (!match) {
                    match = line.match(altPattern);
                }
                
                if (match) {
                    const dateStr = match[1];
                    let description = '';
                    let amountStr = '';
                    
                    if (match.length === 5) {
                        // Format with card number
                        description = match[3].trim();
                        amountStr = match[4];
                    } else {
                        // Alternative format
                        description = match[2].trim();
                        amountStr = match[3];
                    }
                    
                    // Clean up amount
                    const amount = parseFloat(amountStr.replace(/[$,]/g, ''));
                    
                    if (!isNaN(amount) && description.length > 0) {
                        // Parse date
                        const dateParts = dateStr.split('/');
                        let date;
                        if (dateParts[2].length === 2) {
                            // Assume 20YY for 2-digit years
                            date = new Date(`20${dateParts[2]}`, parseInt(dateParts[1]) - 1, dateParts[0]);
                        } else {
                            date = new Date(dateParts[2], parseInt(dateParts[1]) - 1, dateParts[0]);
                        }
                        
                        // Detect category
                        const category = detectCategory(description);
                        
                        // Determine if income or expense
                        // Check for refunds/credits
                        const isRefund = description.toLowerCase().includes('refund') || 
                                       description.toLowerCase().includes('credit') ||
                                       amountStr.includes('-');
                        
                        const type = (category === 'Income' || isRefund) ? 'income' : 'expense';
                        
                        const transaction = {
                            date,
                            description: description.substring(0, 50), // Truncate long descriptions
                            amount: isRefund ? Math.abs(amount) : -Math.abs(amount),
                            balance: 0, // Will calculate running balance later
                            category,
                            type,
                            month: date.toISOString().substring(0, 7)
                        };
                        
                        transactions.push(transaction);
                        
                        // Aggregate by category
                        if (!categories[category]) {
                            categories[category] = 0;
                        }
                        if (type === 'expense') {
                            categories[category] += Math.abs(amount);
                        }
                        
                        // Aggregate by month
                        if (!monthlyData[transaction.month]) {
                            monthlyData[transaction.month] = {
                                income: 0,
                                expenses: 0,
                                transactions: []
                            };
                        }
                        
                        if (type === 'income') {
                            monthlyData[transaction.month].income += Math.abs(amount);
                        } else {
                            monthlyData[transaction.month].expenses += Math.abs(amount);
                        }
                        monthlyData[transaction.month].transactions.push(transaction);
                    }
                }
            });
            
            // Sort transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Calculate running balance
            if (accountDetails.closingBalance) {
                let runningBalance = accountDetails.closingBalance;
                for (let i = 0; i < transactions.length; i++) {
                    transactions[i].balance = runningBalance;
                    runningBalance -= transactions[i].amount;
                }
            }
            
            // Generate budgets based on spending
            generateBudgets();
            
            // Update UI
            updateStats();
            updateCharts();
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
            updateBudgetView();
            generateInsights();
            updateFilters();
        }

        async function processCSVForDocument(file, documentData) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        try {
                            processTransactionsForDocument(results.data, documentData);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        function processCSV(file) {
            // Legacy function for backward compatibility
            processCSVForDocument(file, { transactions: [], accountDetails: {} })
                .then(() => {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                });
        }

        function detectCategory(description) {
            const desc = description.toLowerCase();
            for (const [category, patterns] of Object.entries(categoryPatterns)) {
                if (patterns.some(pattern => desc.includes(pattern))) {
                    return category;
                }
            }
            return 'Other';
        }

        function processTransactionsForDocument(data, documentData) {
            const docTransactions = [];
            
            // Process each transaction
            data.forEach(row => {
                if (!row.Date && !row.date) return;
                
                const date = new Date(row.Date || row.date);
                const description = row.Description || row.description || row.Payee || '';
                const amount = parseFloat(row.Amount || row.amount || row.Debit || row.Credit || 0);
                const balance = parseFloat(row.Balance || row.balance || 0);
                
                if (isNaN(amount)) return;

                const category = detectCategory(description);
                const type = amount > 0 ? 'income' : 'expense';
                
                const transaction = {
                    date,
                    description,
                    amount,
                    balance,
                    category,
                    type,
                    month: date.toISOString().substring(0, 7),
                    sourceDocument: documentData.name
                };
                
                docTransactions.push(transaction);
            });

            // Sort transactions by date
            docTransactions.sort((a, b) => b.date - a.date);
            
            documentData.transactions = docTransactions;
            documentData.processed = true;
        }
        
        function processTransactions(data) {
            // This function is kept for backward compatibility
            const tempDocData = { transactions: [] };
            processTransactionsForDocument(data, tempDocData);
            
            transactions = tempDocData.transactions;
            categories = {};
            monthlyData = {};

            // Process each transaction
            data.forEach(row => {
                if (!row.Date && !row.date) return;
                
                const date = new Date(row.Date || row.date);
                const description = row.Description || row.description || row.Payee || '';
                const amount = parseFloat(row.Amount || row.amount || row.Debit || row.Credit || 0);
                const balance = parseFloat(row.Balance || row.balance || 0);
                
                if (isNaN(amount)) return;

                const category = detectCategory(description);
                const type = amount > 0 ? 'income' : 'expense';
                
                const transaction = {
                    date,
                    description,
                    amount,
                    balance,
                    category,
                    type,
                    month: date.toISOString().substring(0, 7)
                };
                
                transactions.push(transaction);
                
                // Aggregate by category
                if (!categories[category]) {
                    categories[category] = 0;
                }
                if (type === 'expense') {
                    categories[category] += Math.abs(amount);
                }
                
                // Aggregate by month
                if (!monthlyData[transaction.month]) {
                    monthlyData[transaction.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (type === 'income') {
                    monthlyData[transaction.month].income += amount;
                } else {
                    monthlyData[transaction.month].expenses += Math.abs(amount);
                }
                monthlyData[transaction.month].transactions.push(transaction);
            });

            // Sort transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Generate budgets based on spending
            generateBudgets();
            
            // Update UI
            updateStats();
            updateCharts();
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
            updateBudgetView();
            generateInsights();
            updateFilters();
        }

        function updateAccountInfo() {
            const card = document.getElementById('accountInfoCard');
            const container = document.getElementById('accountInfo');
            
            if (Object.keys(accountDetails).length > 0) {
                card.style.display = 'block';
                container.innerHTML = '';
                
                if (accountDetails.accountNumber) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Account Number</span>
                            <span class="account-info-value">****${accountDetails.accountNumber.slice(-4)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.creditLimit) {
                    const availableCredit = accountDetails.creditLimit - (accountDetails.closingBalance || 0);
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Credit Limit</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.creditLimit)}</span>
                        </div>
                        <div class="account-info-item">
                            <span class="account-info-label">Available Credit</span>
                            <span class="account-info-value">${formatCurrency(availableCredit)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.openingBalance) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Opening Balance</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.openingBalance)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.closingBalance) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Closing Balance</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.closingBalance)}</span>
                        </div>
                    `;
                }
            }
        }

        function generateBudgets() {
            // Create suggested budgets based on average spending
            Object.keys(categories).forEach(category => {
                if (category !== 'Income' && category !== 'Savings') {
                    budgets[category] = Math.ceil(categories[category] * 1.1); // 10% buffer
                }
            });
        }

        function updateStats() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().substring(0, 7);
            
            // Get all months of data
            const allMonths = Object.keys(monthlyData).sort();
            const latestMonth = allMonths[allMonths.length - 1] || currentMonth;
            const previousMonth = allMonths[allMonths.length - 2] || lastMonth;
            
            const currentMonthData = monthlyData[latestMonth] || { income: 0, expenses: 0 };
            const lastMonthData = monthlyData[previousMonth] || { income: 0, expenses: 0 };
            
            const totalIncome = currentMonthData.income;
            const totalExpenses = currentMonthData.expenses;
            const netSavings = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? (netSavings / totalIncome * 100) : 0;
            
            const currentBalance = accountDetails.closingBalance || (transactions.length > 0 ? transactions[0].balance : 0);
            const monthStartBalance = accountDetails.openingBalance || (transactions.find(t => t.month !== latestMonth)?.balance || 0);
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netSavings').textContent = formatCurrency(netSavings);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
            
            // Calculate changes
            const incomeChange = lastMonthData.income > 0 ? 
                ((totalIncome - lastMonthData.income) / lastMonthData.income * 100) : 0;
            const expenseChange = lastMonthData.expenses > 0 ? 
                ((totalExpenses - lastMonthData.expenses) / lastMonthData.expenses * 100) : 0;
            
            document.getElementById('incomeChange').textContent = 
                `${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}% from last month`;
            document.getElementById('expenseChange').textContent = 
                `${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}% from last month`;
            document.getElementById('savingsRate').textContent = 
                `${savingsRate.toFixed(1)}% savings rate`;
            document.getElementById('balanceChange').textContent = 
                `${currentBalance - monthStartBalance >= 0 ? '+' : ''}${formatCurrency(currentBalance - monthStartBalance)} this month`;
        }

        function updateCharts() {
            // Destroy existing charts if they exist
            const charts = ['categoryChart', 'trendChart', 'dailyChart'];
            charts.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas.chart) {
                    canvas.chart.destroy();
                }
            });
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = Object.entries(categories)
                .filter(([cat, _]) => cat !== 'Income' && cat !== 'Savings')
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            categoryCtx.canvas.chart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(([cat, _]) => cat),
                    datasets: [{
                        data: categoryData.map(([_, amount]) => amount),
                        backgroundColor: categoryData.map(([cat, _]) => categoryColors[cat] || categoryColors['Other'])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const months = Object.keys(monthlyData).sort().slice(-6);
            
            trendCtx.canvas.chart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: months.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: months.map(m => monthlyData[m].income),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Expenses',
                        data: months.map(m => monthlyData[m].expenses),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
            
            // Daily Spending Chart
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const dailySpending = {};
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const day = daysOfWeek[t.date.getDay()];
                    dailySpending[day] = (dailySpending[day] || 0) + Math.abs(t.amount);
                }
            });
            
            dailyCtx.canvas.chart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: daysOfWeek,
                    datasets: [{
                        label: 'Average Daily Spending',
                        data: daysOfWeek.map(day => dailySpending[day] || 0),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBudgetView() {
            const budgetContainer = document.getElementById('budgetContainer');
            budgetContainer.innerHTML = '';
            
            Object.entries(budgets).forEach(([category, budget]) => {
                const spent = categories[category] || 0;
                const percentage = Math.min((spent / budget * 100), 100);
                const remaining = budget - spent;
                
                const budgetItem = document.createElement('div');
                budgetItem.className = 'budget-item';
                budgetItem.innerHTML = `
                    <div class="budget-label">${category}</div>
                    <div class="budget-bar">
                        <div class="budget-fill" style="width: ${percentage}%; background: ${percentage > 90 ? '#ef4444' : percentage > 75 ? '#f59e0b' : 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)'}">
                            ${percentage.toFixed(0)}%
                        </div>
                    </div>
                    <div class="budget-amount">
                        ${formatCurrency(spent)} / ${formatCurrency(budget)}
                    </div>
                `;
                budgetContainer.appendChild(budgetItem);
            });
        }

        function generateInsights() {
            const insights = [];
            const allMonths = Object.keys(monthlyData).sort();
            const latestMonth = allMonths[allMonths.length - 1];
            const currentMonthData = monthlyData[latestMonth] || { income: 0, expenses: 0 };
            
            // Biggest spending category
            const biggestCategory = Object.entries(categories)
                .filter(([cat, _]) => cat !== 'Income' && cat !== 'Savings')
                .sort((a, b) => b[1] - a[1])[0];
            
            if (biggestCategory) {
                insights.push(`ðŸ’¡ Your biggest spending category is ${biggestCategory[0]} at ${formatCurrency(biggestCategory[1])} this period.`);
            }
            
            // Savings rate insight
            const savingsRate = currentMonthData.income > 0 ? 
                ((currentMonthData.income - currentMonthData.expenses) / currentMonthData.income * 100) : 0;
            
            if (savingsRate > 20) {
                insights.push(`ðŸŽ‰ Great job! You're saving ${savingsRate.toFixed(1)}% of your income.`);
            } else if (savingsRate > 0) {
                insights.push(`ðŸ“Š You're saving ${savingsRate.toFixed(1)}% of your income. Consider aiming for 20% or more.`);
            } else {
                insights.push(`âš ï¸ You're spending more than you earn. Time to review your budget.`);
            }
            
            // Credit utilization for credit cards
            if (accountDetails.creditLimit && accountDetails.closingBalance) {
                const utilization = (accountDetails.closingBalance / accountDetails.creditLimit * 100);
                if (utilization > 30) {
                    insights.push(`ðŸ’³ Your credit utilization is ${utilization.toFixed(1)}%. Consider keeping it below 30% for better credit score.`);
                } else {
                    insights.push(`âœ… Good credit utilization at ${utilization.toFixed(1)}%. Keeping it below 30% helps your credit score.`);
                }
            }
            
            // Unusual spending detection
            const avgDailySpending = currentMonthData.expenses / 30;
            const highSpendingDays = transactions.filter(t => 
                t.type === 'expense' && Math.abs(t.amount) > avgDailySpending * 3
            );
            
            if (highSpendingDays.length > 0) {
                insights.push(`ðŸ“ˆ You had ${highSpendingDays.length} high spending transactions over ${formatCurrency(avgDailySpending * 3)}.`);
            }
            
            // Most frequent merchant
            const merchantFrequency = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const merchant = t.description.split(' ')[0];
                    merchantFrequency[merchant] = (merchantFrequency[merchant] || 0) + 1;
                }
            });
            
            const topMerchant = Object.entries(merchantFrequency)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topMerchant && topMerchant[1] > 3) {
                insights.push(`ðŸ›ï¸ You visited ${topMerchant[0]} ${topMerchant[1]} times. Is this a regular expense you can optimize?`);
            }
            
            // PayPal/subscription spending
            const paypalSpending = categories['PayPal'] || 0;
            const subscriptionSpending = categories['Subscriptions'] || 0;
            if (paypalSpending + subscriptionSpending > currentMonthData.expenses * 0.15) {
                insights.push(`ðŸ’» Online/subscription spending is ${((paypalSpending + subscriptionSpending) / currentMonthData.expenses * 100).toFixed(1)}% of your expenses. Review recurring charges.`);
            }
            
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function updateTransactionsTable() {
            // Use the new pagination system instead of limiting to 50
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
        }

        function updateFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            const uniqueCategories = [...new Set(transactions.map(t => t.category))];
            
            uniqueCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // Add filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
            document.getElementById('startDate').addEventListener('change', filterTransactions);
            document.getElementById('endDate').addEventListener('change', filterTransactions);
        }

        function filterTransactions() {
            const category = document.getElementById('categoryFilter').value;
            const type = document.getElementById('typeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filtered = transactions;
            
            if (category) {
                filtered = filtered.filter(t => t.category === category);
            }
            
            if (type) {
                filtered = filtered.filter(t => t.type === type);
            }
            
            if (startDate) {
                filtered = filtered.filter(t => t.date >= new Date(startDate));
            }
            
            if (endDate) {
                filtered = filtered.filter(t => t.date <= new Date(endDate));
            }
            
            // Update using new pagination system
            filteredTransactions = filtered;
            currentPage = 1;
            updateTransactionsDisplayWithPagination();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(Math.abs(amount));
        }

        function showProcessingStatus(totalFiles) {
            const dashboard = document.getElementById('dashboard');
            const existingStatus = document.getElementById('processingStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.id = 'processingStatus';
            statusDiv.className = 'processing-status';
            statusDiv.innerHTML = `
                <div>
                    <strong>Processing ${totalFiles} file(s)...</strong>
                    <div id="processingText">Starting...</div>
                </div>
                <div class="processing-progress">
                    <div class="processing-progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            `;
            
            dashboard.insertBefore(statusDiv, dashboard.firstChild);
        }
        
        function updateProcessingProgress(processed, total) {
            const progressBar = document.getElementById('progressBar');
            const processingText = document.getElementById('processingText');
            
            if (progressBar && processingText) {
                const percentage = (processed / total) * 100;
                progressBar.style.width = `${percentage}%`;
                processingText.textContent = `Processed ${processed} of ${total} files`;
                
                if (processed === total) {
                    processingText.textContent = 'Combining data from all documents...';
                    setTimeout(() => {
                        const statusDiv = document.getElementById('processingStatus');
                        if (statusDiv) {
                            statusDiv.remove();
                        }
                    }, 1000);
                }
            }
        }
        
        function combineDocumentData() {
            transactions = [];
            categories = {};
            monthlyData = {};
            accountDetails = {};
            
            // Combine all transactions from all documents
            uploadedDocuments.forEach(doc => {
                if (doc.processed && doc.transactions) {
                    transactions.push(...doc.transactions);
                }
                
                // Merge account details (prefer the most complete one)
                if (doc.accountDetails && Object.keys(doc.accountDetails).length > Object.keys(accountDetails).length) {
                    accountDetails = { ...accountDetails, ...doc.accountDetails };
                }
            });
            
            // Sort all transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Recalculate categories and monthly data
            transactions.forEach(t => {
                // Aggregate by category
                if (!categories[t.category]) {
                    categories[t.category] = 0;
                }
                if (t.type === 'expense') {
                    categories[t.category] += Math.abs(t.amount);
                }
                
                // Aggregate by month
                if (!monthlyData[t.month]) {
                    monthlyData[t.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (t.type === 'income') {
                    monthlyData[t.month].income += Math.abs(t.amount);
                } else {
                    monthlyData[t.month].expenses += Math.abs(t.amount);
                }
                monthlyData[t.month].transactions.push(t);
            });
            
            // Generate budgets and update UI
            generateBudgets();
            updateStats();
            updateCharts();
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
            updateBudgetView();
            generateInsights();
            updateFilters();
            
            if (Object.keys(accountDetails).length > 0) {
                updateAccountInfo();
            }
        }
        
        function updateDocumentManager() {
            const documentList = document.getElementById('documentList');
            const documentCount = document.getElementById('documentCount');
            
            documentCount.textContent = uploadedDocuments.length;
            documentList.innerHTML = '';
            
            // Add "All Documents" option if we have multiple documents
            if (uploadedDocuments.length > 1) {
                const allDocsItem = document.createElement('div');
                allDocsItem.className = `document-item ${currentDocumentIndex === -1 ? 'active' : ''}`;
                allDocsItem.innerHTML = `
                    <div class="document-name" onclick="showAllDocuments()">ðŸ“Š All Documents Combined</div>
                    <div class="document-stats">
                        Combined view â€¢ ${transactions.length} total transactions
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="showAllDocuments()">View Combined</button>
                    </div>
                `;
                documentList.appendChild(allDocsItem);
            }
            
            uploadedDocuments.forEach((doc, index) => {
                const docItem = document.createElement('div');
                docItem.className = `document-item ${index === currentDocumentIndex ? 'active' : ''}`;
                docItem.innerHTML = `
                    <div class="document-name" onclick="viewDocument(${index})">${doc.name}</div>
                    <div class="document-stats">
                        ${doc.type} â€¢ ${(doc.size / 1024).toFixed(1)} KB â€¢ ${doc.transactions?.length || 0} transactions
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="viewDocument(${index})">View</button>
                        <button class="document-btn remove" onclick="removeDocument(${index})">Remove</button>
                    </div>
                `;
                documentList.appendChild(docItem);
            });
        }
        
        function viewDocument(index) {
            currentDocumentIndex = index;
            const doc = uploadedDocuments[index];
            
            // Update UI to show only this document's data
            transactions = [...doc.transactions];
            accountDetails = { ...doc.accountDetails };
            
            // Recalculate stats for this document only
            categories = {};
            monthlyData = {};
            
            transactions.forEach(t => {
                if (!categories[t.category]) {
                    categories[t.category] = 0;
                }
                if (t.type === 'expense') {
                    categories[t.category] += Math.abs(t.amount);
                }
                
                if (!monthlyData[t.month]) {
                    monthlyData[t.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (t.type === 'income') {
                    monthlyData[t.month].income += Math.abs(t.amount);
                } else {
                    monthlyData[t.month].expenses += Math.abs(t.amount);
                }
                monthlyData[t.month].transactions.push(t);
            });
            
            generateBudgets();
            updateStats();
            updateCharts();
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
            updateBudgetView();
            generateInsights();
            updateFilters();
            updateAccountInfo();
            updateDocumentManager();
        }
        
        function removeDocument(index) {
            if (confirm(`Are you sure you want to remove "${uploadedDocuments[index].name}"?`)) {
                uploadedDocuments.splice(index, 1);
                
                if (uploadedDocuments.length === 0) {
                    // Reset everything
                    transactions = [];
                    categories = {};
                    monthlyData = {};
                    budgets = {};
                    accountDetails = {};
                    document.getElementById('uploadSection').style.display = 'block';
                    document.getElementById('dashboard').classList.remove('active');
                } else {
                    // Recombine remaining documents
                    combineDocumentData();
                    updateDocumentManager();
                }
            }
        }
        
        function clearAllDocuments() {
            if (confirm('Are you sure you want to remove all documents and start over?')) {
                uploadedDocuments = [];
                transactions = [];
                categories = {};
                monthlyData = {};
                budgets = {};
                accountDetails = {};
                currentDocumentIndex = 0;
                
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('documentManager').style.display = 'none';
            }
        }
        
        function addMoreDocuments() {
            document.getElementById('fileInput').click();
        }
        
        function showAllDocuments() {
            currentDocumentIndex = -1; // -1 indicates "all documents" view
            combineDocumentData();
            updateDocumentManager();
        }
        
        // Theme switching functionality
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            console.log('Theme switching from', currentTheme, 'to', newTheme);
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('preferred-theme', newTheme);
            
            // Apply theme immediately with inline styles as fallback
            if (newTheme === 'light') {
                document.documentElement.style.setProperty('--vscode-editor-background', '#ffffff');
                document.documentElement.style.setProperty('--vscode-editor-foreground', '#24292f');
                document.documentElement.style.setProperty('--vscode-panel-background', '#f6f8fa');
                document.documentElement.style.setProperty('--vscode-card-background', '#ffffff');
                document.documentElement.style.setProperty('--vscode-border-color', '#d1d9e0');
            } else {
                document.documentElement.style.setProperty('--vscode-editor-background', '#1e1e1e');
                document.documentElement.style.setProperty('--vscode-editor-foreground', '#d4d4d4');
                document.documentElement.style.setProperty('--vscode-panel-background', '#2d2d30');
                document.documentElement.style.setProperty('--vscode-card-background', '#252526');
                document.documentElement.style.setProperty('--vscode-border-color', '#3c3c3c');
            }
        }
        
        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('preferred-theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaultTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            
            console.log('Initializing theme:', defaultTheme);
            document.documentElement.setAttribute('data-theme', defaultTheme);
            
            // Ensure the theme is applied immediately
            if (defaultTheme === 'light') {
                document.documentElement.style.setProperty('--vscode-editor-background', '#ffffff');
                document.documentElement.style.setProperty('--vscode-editor-foreground', '#24292f');
            } else {
                document.documentElement.style.setProperty('--vscode-editor-background', '#1e1e1e');
                document.documentElement.style.setProperty('--vscode-editor-foreground', '#d4d4d4');
            }
        }
        
        // Initialize theme immediately
        initializeTheme();
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('preferred-theme')) {
                const newTheme = e.matches ? 'dark' : 'light';
                console.log('System theme changed to:', newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
            }
        });
        
        function loadSampleData() {
            const sampleData = generateSampleData();
            
            // Create a mock document for sample data
            const sampleDoc = {
                name: 'Sample_Bank_Statement.csv',
                size: 50000,
                type: 'CSV',
                uploadDate: new Date(),
                transactions: [],
                accountDetails: {},
                processed: false
            };
            
            processTransactionsForDocument(sampleData, sampleDoc);
            
            uploadedDocuments = [sampleDoc];
            currentDocumentIndex = -1; // Start with "all documents" view
            combineDocumentData();
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('documentManager').style.display = 'block';
            updateDocumentManager();
        }

        function generateSampleData() {
            const data = [];
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3);
            let balance = 5000;
            
            const sampleTransactions = [
                { desc: 'Salary Deposit', amount: 5000, cat: 'Income' },
                { desc: 'Woolworths Supermarket', amount: -156.32, cat: 'Groceries' },
                { desc: 'Netflix Subscription', amount: -15.99, cat: 'Entertainment' },
                { desc: 'Ampol Petrol Station', amount: -45.00, cat: 'Transportation' },
                { desc: 'Starbucks Coffee', amount: -5.75, cat: 'Dining' },
                { desc: 'Amazon Marketplace AU', amount: -89.99, cat: 'Shopping' },
                { desc: 'Energy Australia', amount: -120.00, cat: 'Utilities' },
                { desc: 'Rent Payment', amount: -1500.00, cat: 'Housing' },
                { desc: 'Nandos Restaurant', amount: -42.50, cat: 'Dining' },
                { desc: 'Kmart Store', amount: -67.43, cat: 'Shopping' },
                { desc: 'Uber Ride', amount: -18.50, cat: 'Transportation' },
                { desc: 'Chemist Warehouse', amount: -25.00, cat: 'Healthcare' },
                { desc: 'Freelance Payment', amount: 1200.00, cat: 'Income' },
                { desc: 'Spotify Premium', amount: -9.99, cat: 'Entertainment' },
                { desc: 'Coles Supermarket', amount: -98.76, cat: 'Groceries' },
                { desc: 'BP Service Station', amount: -40.00, cat: 'Transportation' },
                { desc: 'Sushi Train', amount: -45.00, cat: 'Dining' },
                { desc: 'AAMI Insurance', amount: -150.00, cat: 'Insurance' },
                { desc: 'Anytime Fitness', amount: -50.00, cat: 'Healthcare' },
                { desc: 'Telstra Mobile', amount: -60.00, cat: 'Utilities' },
                { desc: 'PayPal Transfer', amount: -125.00, cat: 'PayPal' },
                { desc: 'Bunnings Warehouse', amount: -89.95, cat: 'Shopping' },
                { desc: 'DoorDash Delivery', amount: -32.45, cat: 'Dining' }
            ];
            
            for (let i = 0; i < 90; i++) {
                const transaction = sampleTransactions[Math.floor(Math.random() * sampleTransactions.length)];
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                
                balance += transaction.amount;
                
                data.push({
                    Date: date.toISOString().split('T')[0],
                    Description: transaction.desc,
                    Amount: transaction.amount,
                    Balance: balance
                });
            }
            
            return data.reverse();
        }

        function exportToCSV() {
            const csvContent = Papa.unparse(transactions.map(t => ({
                Date: t.date.toISOString().split('T')[0],
                Description: t.description,
                Category: t.category,
                Amount: t.amount,
                Balance: t.balance,
                Type: t.type
            })));
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_report.csv';
            a.click();
        }

        function generateReport() {
            const report = {
                summary: {
                    totalTransactions: transactions.length,
                    categories: Object.keys(categories).length,
                    dateRange: transactions.length > 0 ? 
                        `${transactions[transactions.length - 1].date.toLocaleDateString()} - ${transactions[0].date.toLocaleDateString()}` : 
                        'No data',
                    ...accountDetails
                },
                monthlyBreakdown: monthlyData,
                categoryBreakdown: categories,
                insights: document.getElementById('insightsList').innerText
            };
            
            const reportJson = JSON.stringify(report, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_report.json';
            a.click();
            
            alert('Financial report generated! The report includes your transaction summary, monthly breakdown, category analysis, and personalized insights.');
        }

        // ===== AD-HOC ANALYSIS FEATURES =====

        // Global variables for filtering and pagination
        let filteredTransactions = [];
        let currentFilters = {
            dateRange: null,
            search: null,
            duplicates: false,
            transfers: false,
            anomalies: false
        };
        let currentPage = 1;
        let pageSize = 25;
        let totalPages = 1;
        let displayedTransactions = [];

        // Document Comparison & Consolidation
        function findDuplicates() {
            const duplicates = [];
            const seen = new Map();
            
            transactions.forEach((transaction, index) => {
                const key = `${transaction.date.toDateString()}_${Math.abs(transaction.amount)}_${transaction.description.toLowerCase().trim()}`;
                
                if (seen.has(key)) {
                    const originalIndex = seen.get(key);
                    duplicates.push({
                        original: transactions[originalIndex],
                        duplicate: transaction,
                        confidence: calculateDuplicateConfidence(transactions[originalIndex], transaction)
                    });
                } else {
                    seen.set(key, index);
                }
            });
            
            displayDuplicates(duplicates);
            document.querySelector('[onclick="findDuplicates()"]').classList.add('active');
        }

        function calculateDuplicateConfidence(t1, t2) {
            let score = 0;
            
            // Same date
            if (t1.date.toDateString() === t2.date.toDateString()) score += 30;
            
            // Same amount
            if (Math.abs(t1.amount - t2.amount) < 0.01) score += 40;
            
            // Similar description
            const desc1 = t1.description.toLowerCase().replace(/[^a-z0-9]/g, '');
            const desc2 = t2.description.toLowerCase().replace(/[^a-z0-9]/g, '');
            const similarity = calculateStringSimilarity(desc1, desc2);
            score += similarity * 30;
            
            return Math.round(score);
        }

        function calculateStringSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        function findTransfers() {
            const transfers = [];
            const tolerance = 0.01; // Allow for small differences due to fees
            
            transactions.forEach((transaction, index) => {
                if (transaction.type === 'expense') {
                    // Look for corresponding income transaction
                    const matches = transactions.filter((t, i) => 
                        i !== index && 
                        t.type === 'income' && 
                        Math.abs(Math.abs(transaction.amount) - t.amount) <= tolerance &&
                        Math.abs(transaction.date.getTime() - t.date.getTime()) <= 3 * 24 * 60 * 60 * 1000 // Within 3 days
                    );
                    
                    matches.forEach(match => {
                        transfers.push({
                            outgoing: transaction,
                            incoming: match,
                            difference: Math.abs(Math.abs(transaction.amount) - match.amount)
                        });
                    });
                }
            });
            
            displayTransfers(transfers);
            document.querySelector('[onclick="findTransfers()"]').classList.add('active');
        }

        function findAnomalies() {
            const anomalies = [];
            
            // Calculate statistics by category
            const categoryStats = {};
            Object.keys(categories).forEach(category => {
                const categoryTransactions = transactions.filter(t => t.category === category && t.type === 'expense');
                if (categoryTransactions.length > 0) {
                    const amounts = categoryTransactions.map(t => Math.abs(t.amount));
                    const mean = amounts.reduce((a, b) => a + b, 0) / amounts.length;
                    const variance = amounts.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / amounts.length;
                    const stdDev = Math.sqrt(variance);
                    
                    categoryStats[category] = { mean, stdDev, transactions: categoryTransactions };
                }
            });
            
            // Find transactions that are more than 2 standard deviations from the mean
            Object.entries(categoryStats).forEach(([category, stats]) => {
                stats.transactions.forEach(transaction => {
                    const zScore = Math.abs((Math.abs(transaction.amount) - stats.mean) / stats.stdDev);
                    if (zScore > 2 && stats.stdDev > 0) {
                        anomalies.push({
                            transaction,
                            zScore: zScore.toFixed(2),
                            reason: `${zScore.toFixed(1)}Ïƒ from mean for ${category}`,
                            expectedRange: `$${(stats.mean - 2 * stats.stdDev).toFixed(2)} - $${(stats.mean + 2 * stats.stdDev).toFixed(2)}`
                        });
                    }
                });
            });
            
            // Also find weekend/unusual time transactions
            transactions.forEach(transaction => {
                const day = transaction.date.getDay();
                const hour = transaction.date.getHours();
                
                if ((day === 0 || day === 6) && Math.abs(transaction.amount) > 100) {
                    anomalies.push({
                        transaction,
                        reason: 'Large weekend transaction',
                        zScore: 'N/A'
                    });
                }
                
                if ((hour < 6 || hour > 22) && Math.abs(transaction.amount) > 50) {
                    anomalies.push({
                        transaction,
                        reason: 'Late night/early morning transaction',
                        zScore: 'N/A'
                    });
                }
            });
            
            displayAnomalies(anomalies);
            document.querySelector('[onclick="findAnomalies()"]').classList.add('active');
        }

        function analyzeFrequency() {
            const merchantFrequency = {};
            const categoryFrequency = {};
            
            transactions.forEach(transaction => {
                // Merchant frequency
                const merchant = transaction.description.split(' ')[0].toLowerCase();
                merchantFrequency[merchant] = (merchantFrequency[merchant] || 0) + 1;
                
                // Category frequency
                categoryFrequency[transaction.category] = (categoryFrequency[transaction.category] || 0) + 1;
            });
            
            // Find recurring patterns
            const recurringMerchants = Object.entries(merchantFrequency)
                .filter(([merchant, count]) => count >= 3)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Find potential subscriptions (similar amounts, regular intervals)
            const potentialSubscriptions = findSubscriptions();
            
            displayFrequencyAnalysis({
                recurringMerchants,
                categoryFrequency,
                potentialSubscriptions
            });
            
            document.querySelector('[onclick="analyzeFrequency()"]').classList.add('active');
        }

        function findSubscriptions() {
            const subscriptions = [];
            const merchantGroups = {};
            
            transactions.forEach(transaction => {
                const merchant = transaction.description.toLowerCase().replace(/[^a-z]/g, '');
                if (!merchantGroups[merchant]) merchantGroups[merchant] = [];
                merchantGroups[merchant].push(transaction);
            });
            
            Object.entries(merchantGroups).forEach(([merchant, transactions]) => {
                if (transactions.length >= 3) {
                    const amounts = transactions.map(t => Math.abs(t.amount));
                    const avgAmount = amounts.reduce((a, b) => a + b, 0) / amounts.length;
                    const variance = amounts.reduce((a, b) => a + Math.pow(b - avgAmount, 2), 0) / amounts.length;
                    
                    // If amounts are similar (low variance) and occur regularly
                    if (variance < avgAmount * 0.1) {
                        const dates = transactions.map(t => t.date).sort((a, b) => a - b);
                        const intervals = [];
                        for (let i = 1; i < dates.length; i++) {
                            const daysDiff = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                            intervals.push(daysDiff);
                        }
                        
                        const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                        if (avgInterval >= 25 && avgInterval <= 35) { // Monthly-ish
                            subscriptions.push({
                                merchant: transactions[0].description,
                                amount: avgAmount,
                                frequency: `Every ${Math.round(avgInterval)} days`,
                                transactions: transactions.length
                            });
                        }
                    }
                }
            });
            
            return subscriptions;
        }

        // Search and filtering functions
        function searchTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value;
            if (!searchTerm) {
                clearFilters();
                return;
            }
            
            try {
                const regex = new RegExp(searchTerm, 'i');
                filteredTransactions = transactions.filter(t => 
                    regex.test(t.description) || 
                    regex.test(t.category) || 
                    regex.test(t.amount.toString())
                );
                
                currentFilters.search = searchTerm;
                currentPage = 1;
                updateTransactionsDisplayWithPagination();
                
            } catch (e) {
                // If regex is invalid, do simple text search
                const term = searchTerm.toLowerCase();
                filteredTransactions = transactions.filter(t => 
                    t.description.toLowerCase().includes(term) || 
                    t.category.toLowerCase().includes(term) || 
                    t.amount.toString().includes(term)
                );
                
                currentFilters.search = searchTerm;
                currentPage = 1;
                updateTransactionsDisplayWithPagination();
            }
        }

        function applyDateFilter() {
            const startDate = new Date(document.getElementById('analysisStartDate').value);
            const endDate = new Date(document.getElementById('analysisEndDate').value);
            
            if (startDate && endDate) {
                filteredTransactions = transactions.filter(t => 
                    t.date >= startDate && t.date <= endDate
                );
                
                currentFilters.dateRange = { startDate, endDate };
                currentPage = 1;
                updateTransactionsDisplayWithPagination();
                updateStatsForFiltered(filteredTransactions);
            }
        }

        function clearFilters() {
            filteredTransactions = [];
            currentFilters = {
                dateRange: null,
                search: null,
                duplicates: false,
                transfers: false,
                anomalies: false
            };
            
            // Clear all filter inputs
            document.getElementById('transactionSearch').value = '';
            document.getElementById('analysisStartDate').value = '';
            document.getElementById('analysisEndDate').value = '';
            
            // Clear original filter inputs too
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (categoryFilter) categoryFilter.value = '';
            if (typeFilter) typeFilter.value = '';
            if (startDate) startDate.value = '';
            if (endDate) endDate.value = '';
            
            // Remove active states
            document.querySelectorAll('.filter-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Reset pagination
            currentPage = 1;
            
            // Update display with all transactions
            displayedTransactions = transactions;
            updateTransactionsDisplayWithPagination();
            hideAnalysisResults();
        }

        // Display functions
        function displayDuplicates(duplicates) {
            const html = `
                <div class="insight-card error">
                    <h4>Potential Duplicates Found</h4>
                    <p>Found ${duplicates.length} potential duplicate transactions:</p>
                    ${duplicates.map(dup => `
                        <div style="margin: 10px 0; padding: 10px; background: var(--vscode-panel-background); border-radius: 4px;">
                            <strong>Confidence: ${dup.confidence}%</strong><br>
                            Original: ${dup.original.date.toLocaleDateString()} - ${dup.original.description} - $${dup.original.amount}<br>
                            Duplicate: ${dup.duplicate.date.toLocaleDateString()} - ${dup.duplicate.description} - $${dup.duplicate.amount}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('advancedInsightsList').innerHTML = html;
            document.getElementById('advancedInsights').style.display = 'block';
        }

        function displayTransfers(transfers) {
            const html = `
                <div class="insight-card info">
                    <h4>Account Transfers Detected</h4>
                    <p>Found ${transfers.length} potential transfers between accounts:</p>
                    ${transfers.map(transfer => `
                        <div style="margin: 10px 0; padding: 10px; background: var(--vscode-panel-background); border-radius: 4px;">
                            Outgoing: ${transfer.outgoing.date.toLocaleDateString()} - ${transfer.outgoing.description} - $${transfer.outgoing.amount}<br>
                            Incoming: ${transfer.incoming.date.toLocaleDateString()} - ${transfer.incoming.description} - $${transfer.incoming.amount}<br>
                            ${transfer.difference > 0 ? `Fee: $${transfer.difference.toFixed(2)}` : 'Exact match'}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('advancedInsightsList').innerHTML = html;
            document.getElementById('advancedInsights').style.display = 'block';
        }

        function displayAnomalies(anomalies) {
            const html = `
                <div class="insight-card warning">
                    <h4>Transaction Anomalies</h4>
                    <p>Found ${anomalies.length} unusual transactions:</p>
                    ${anomalies.map(anomaly => `
                        <div style="margin: 10px 0; padding: 10px; background: var(--vscode-panel-background); border-radius: 4px;">
                            <strong>${anomaly.transaction.date.toLocaleDateString()}</strong> - ${anomaly.transaction.description}<br>
                            Amount: $${anomaly.transaction.amount} | Reason: ${anomaly.reason}<br>
                            ${anomaly.expectedRange ? `Expected range: ${anomaly.expectedRange}` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('advancedInsightsList').innerHTML = html;
            document.getElementById('advancedInsights').style.display = 'block';
        }

        function displayFrequencyAnalysis(analysis) {
            const html = `
                <div class="insight-card success">
                    <h4>Frequency Analysis</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5>Most Frequent Merchants:</h5>
                            ${analysis.recurringMerchants.map(([merchant, count]) => `
                                <div>${merchant}: ${count} transactions</div>
                            `).join('')}
                        </div>
                        <div>
                            <h5>Potential Subscriptions:</h5>
                            ${analysis.potentialSubscriptions.map(sub => `
                                <div>
                                    <strong>${sub.merchant}</strong><br>
                                    $${sub.amount.toFixed(2)} ${sub.frequency}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('advancedInsightsList').innerHTML = html;
            document.getElementById('advancedInsights').style.display = 'block';
        }

        // New unified transaction display system with pagination
        function updateTransactionsDisplayWithPagination() {
            const dataToShow = filteredTransactions.length > 0 ? filteredTransactions : displayedTransactions.length > 0 ? displayedTransactions : transactions;
            
            // Calculate pagination
            totalPages = Math.ceil(dataToShow.length / pageSize);
            currentPage = Math.min(currentPage, Math.max(1, totalPages));
            
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, dataToShow.length);
            const pageData = dataToShow.slice(startIndex, endIndex);
            
            // Update table
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            pageData.forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.date.toLocaleDateString()}</td>
                    <td>${t.description}</td>
                    <td><span class="category-badge" style="background: ${categoryColors[t.category] || '#6b7280'}">${t.category}</span></td>
                    <td class="${t.type}">${t.type === 'income' ? '+' : ''}$${t.amount.toFixed(2)}</td>
                    <td>${t.balance ? '$' + t.balance.toFixed(2) : '-'}</td>
                    <td class="source-doc">${t.sourceDocument || 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Update pagination controls
            updatePaginationControls(dataToShow.length, startIndex + 1, endIndex);
        }

        function updatePaginationControls(totalItems, startIndex, endIndex) {
            const paginationControls = document.getElementById('paginationControls');
            const paginationInfo = document.getElementById('paginationInfo');
            const pageNumbers = document.getElementById('pageNumbers');
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');
            
            // Show/hide pagination
            if (totalItems > pageSize) {
                paginationControls.style.display = 'flex';
                
                // Update info
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalItems} transactions`;
                
                // Update buttons
                firstBtn.disabled = currentPage === 1;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                lastBtn.disabled = currentPage === totalPages;
                
                // Update page numbers
                pageNumbers.innerHTML = '';
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage < maxVisiblePages - 1) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('span');
                    pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbers.appendChild(pageBtn);
                }
            } else {
                paginationControls.style.display = 'none';
            }
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updateTransactionsDisplayWithPagination();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            updateTransactionsDisplayWithPagination();
        }

        // Legacy function for backward compatibility
        function updateTransactionsDisplay(transactionsToShow) {
            displayedTransactions = transactionsToShow;
            filteredTransactions = transactionsToShow;
            currentPage = 1;
            updateTransactionsDisplayWithPagination();
        }

        function updateStatsForFiltered(filteredTransactions) {
            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = Math.abs(filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
            
            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('netSavings').textContent = `$${(totalIncome - totalExpenses).toFixed(2)}`;
        }

        function hideAnalysisResults() {
            document.getElementById('advancedInsights').style.display = 'none';
            document.getElementById('documentIntelligence').style.display = 'none';
        }

        // Document Intelligence
        function generateDocumentIntelligence() {
            const analysis = uploadedDocuments.map(doc => {
                const docTransactions = doc.transactions || [];
                const dateRange = docTransactions.length > 0 ? {
                    start: new Date(Math.min(...docTransactions.map(t => t.date))),
                    end: new Date(Math.max(...docTransactions.map(t => t.date)))
                } : null;
                
                const totalSpent = docTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const totalIncome = docTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const avgTransaction = docTransactions.length > 0 ? (totalSpent + totalIncome) / docTransactions.length : 0;
                
                const categories = {};
                docTransactions.forEach(t => {
                    categories[t.category] = (categories[t.category] || 0) + 1;
                });
                
                const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
                
                return {
                    name: doc.name,
                    type: detectDocumentType(doc),
                    transactions: docTransactions.length,
                    dateRange,
                    totalSpent,
                    totalIncome,
                    avgTransaction,
                    topCategory: topCategory ? topCategory[0] : 'None',
                    accountDetails: doc.accountDetails || {}
                };
            });
            
            displayDocumentIntelligence(analysis);
        }

        function detectDocumentType(doc) {
            const name = doc.name.toLowerCase();
            if (name.includes('statement') || name.includes('account')) return 'Bank Statement';
            if (name.includes('credit')) return 'Credit Card Statement';
            if (name.includes('csv') || name.includes('export')) return 'Transaction Export';
            return 'Financial Document';
        }

        function displayDocumentIntelligence(analysis) {
            const html = analysis.map(doc => `
                <div class="doc-analysis-card">
                    <h4>${doc.name}</h4>
                    <div class="analysis-metric">
                        <span class="label">Type:</span>
                        <span class="value">${doc.type}</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="label">Transactions:</span>
                        <span class="value">${doc.transactions}</span>
                    </div>
                    ${doc.dateRange ? `
                        <div class="analysis-metric">
                            <span class="label">Date Range:</span>
                            <span class="value">${doc.dateRange.start.toLocaleDateString()} - ${doc.dateRange.end.toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                    <div class="analysis-metric">
                        <span class="label">Total Spent:</span>
                        <span class="value">$${doc.totalSpent.toFixed(2)}</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="label">Total Income:</span>
                        <span class="value">$${doc.totalIncome.toFixed(2)}</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="label">Avg Transaction:</span>
                        <span class="value">$${doc.avgTransaction.toFixed(2)}</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="label">Top Category:</span>
                        <span class="value">${doc.topCategory}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('documentAnalysis').innerHTML = html;
            document.getElementById('documentIntelligence').style.display = 'block';
        }

        // Enhanced reporting
        function generateEnhancedReport() {
            const report = {
                metadata: {
                    generatedAt: new Date().toISOString(),
                    totalDocuments: uploadedDocuments.length,
                    totalTransactions: transactions.length,
                    dateRange: transactions.length > 0 ? {
                        start: transactions[transactions.length - 1].date.toISOString(),
                        end: transactions[0].date.toISOString()
                    } : null
                },
                summary: {
                    totalIncome: transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0),
                    totalExpenses: Math.abs(transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)),
                    netSavings: transactions.reduce((sum, t) => sum + t.amount, 0),
                    accountDetails: accountDetails
                },
                categories: categories,
                monthlyBreakdown: monthlyData,
                documentIntelligence: uploadedDocuments.map(doc => ({
                    name: doc.name,
                    type: detectDocumentType(doc),
                    transactions: (doc.transactions || []).length,
                    processed: doc.processed
                })),
                insights: generateInsights()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enhanced_financial_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Enhanced financial report generated with fraud detection, duplicate analysis, and advanced insights!');
        }

        function generateTaxReport() {
            const taxCategories = {
                'Business Expenses': ['Office', 'Software', 'Internet', 'Phone'],
                'Medical': ['Healthcare', 'Pharmacy', 'Medical'],
                'Charitable': ['Donation', 'Charity'],
                'Investment': ['Investment', 'Broker', 'Trading'],
                'Income': ['Salary', 'Freelance', 'Investment Income']
            };
            
            const taxReport = {
                year: new Date().getFullYear(),
                summary: {},
                transactions: {}
            };
            
            Object.entries(taxCategories).forEach(([taxCategory, categories]) => {
                const relevantTransactions = transactions.filter(t => 
                    categories.some(cat => t.category.toLowerCase().includes(cat.toLowerCase()))
                );
                
                taxReport.summary[taxCategory] = relevantTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);
                taxReport.transactions[taxCategory] = relevantTransactions;
            });
            
            const blob = new Blob([JSON.stringify(taxReport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax_summary_${new Date().getFullYear()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Tax summary report generated! Review for potential deductions and income reporting.');
        }

        function clearSession() {
            if (confirm('Are you sure you want to clear all data? This will remove all uploaded documents and analysis.')) {
                transactions = [];
                categories = {};
                monthlyData = {};
                budgets = {};
                accountDetails = {};
                uploadedDocuments = [];
                currentDocumentIndex = 0;
                filteredTransactions = [];
                currentFilters = {
                    dateRange: null,
                    search: null,
                    duplicates: false,
                    transfers: false,
                    anomalies: false
                };
                
                // Hide all panels
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('documentManager').style.display = 'none';
                document.getElementById('accountInfoCard').style.display = 'none';
                document.getElementById('analysisToolbar').style.display = 'none';
                document.getElementById('documentIntelligence').style.display = 'none';
                document.getElementById('advancedInsights').style.display = 'none';
                
                // Show upload section
                document.getElementById('uploadSection').style.display = 'block';
                
                alert('Session cleared! You can now upload new documents for analysis.');
            }
        }

        // Override existing functions to show analysis tools
        const originalCombineDocumentData = combineDocumentData;
        combineDocumentData = function() {
            originalCombineDocumentData();
            
            // Show analysis tools when data is loaded
            if (transactions.length > 0) {
                document.getElementById('analysisToolbar').style.display = 'block';
                generateDocumentIntelligence();
                
                // Initialize pagination
                displayedTransactions = transactions;
                currentPage = 1;
                updateTransactionsDisplayWithPagination();
            }
        };
    </script>
</body>
</html>