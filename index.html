<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Dashboard - PDF & CSV Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .privacy-badge svg {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 60px 40px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #edf2ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #edf2ff;
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
        }

        input[type="file"] {
            display: none;
        }

        .format-badges {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .format-badge {
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 0.85em;
            color: #4b5563;
            font-weight: 500;
        }

        .format-badge.pdf {
            background: #fee2e2;
            color: #dc2626;
        }

        .format-badge.csv {
            background: #dcfce7;
            color: #16a34a;
        }

        .sample-data-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #f3f4f6;
            border: none;
            border-radius: 10px;
            color: #374151;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.3s;
        }

        .sample-data-btn:hover {
            background: #e5e7eb;
        }

        .dashboard {
            display: none;
            gap: 30px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .dashboard.active {
            display: grid;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 svg {
            width: 24px;
            height: 24px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-change {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transactions-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .transactions-table tr:hover {
            background: #f9fafb;
        }

        .amount-positive {
            color: #10b981;
            font-weight: 600;
        }

        .amount-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .budget-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .budget-label {
            flex: 1;
            font-size: 0.95em;
            color: #4b5563;
        }

        .budget-bar {
            flex: 2;
            height: 30px;
            background: #f3f4f6;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 0 15px;
        }

        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 0.85em;
            font-weight: 500;
        }

        .budget-amount {
            font-size: 0.9em;
            color: #374151;
            font-weight: 500;
            min-width: 100px;
            text-align: right;
        }

        .insights-list {
            list-style: none;
        }

        .insights-list li {
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            color: #4b5563;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }

        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .document-item {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .document-item.active {
            background: #eef2ff;
            border-left-color: #3b82f6;
        }

        .document-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .document-stats {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .document-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .document-btn.view {
            background: #e0e7ff;
            color: #3730a3;
        }

        .document-btn.view:hover {
            background: #c7d2fe;
        }

        .document-btn.remove {
            background: #fee2e2;
            color: #dc2626;
        }

        .document-btn.remove:hover {
            background: #fecaca;
        }

        .processing-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border-left: 4px solid #0ea5e9;
        }

        .processing-progress {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .processing-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #3b82f6);
            transition: width 0.3s;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .half-width {
            grid-column: span 1;
        }

        .extraction-preview {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .extraction-preview h3 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .extraction-preview pre {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #4b5563;
            white-space: pre-wrap;
        }

        .account-info {
            background: #eef2ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .account-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .account-info-label {
            color: #6b7280;
        }

        .account-info-value {
            color: #374151;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .half-width {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’° Personal Finance Dashboard</h1>
            <p>Analyze bank statements from PDFs or CSVs - Extract, visualize, and gain insights</p>
            <div class="privacy-badge">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                100% Private - No data leaves your device
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <h3 style="color: #374151; margin-bottom: 10px;">Drop your bank statements here</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">Support multiple files - or click to browse</p>
                <div class="format-badges">
                    <span class="format-badge pdf">PDF Statements</span>
                    <span class="format-badge csv">CSV Exports</span>
                </div>
                <p style="color: #9ca3af; font-size: 0.9em; margin-top: 15px;">
                    Supports: HSBC, Commonwealth Bank, ANZ, Westpac, NAB, and most major banks
                </p>
                <input type="file" id="fileInput" accept=".pdf,.csv" multiple>
            </div>
            <button class="sample-data-btn" onclick="loadSampleData()">Load Sample Data to Try It Out</button>
            <div id="extractionPreview" class="extraction-preview" style="display: none;">
                <h3>ðŸ“„ Extracted Data Preview</h3>
                <pre id="extractionContent"></pre>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: white; font-size: 1.1em;">Extracting and analyzing your financial data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Document Management -->
            <div class="card full-width" id="documentManager" style="display: none;">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Uploaded Documents (<span id="documentCount">0</span>)
                </h2>
                <div id="documentList" class="document-list"></div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="clearAllDocuments()">Clear All</button>
                    <button class="export-btn" onclick="addMoreDocuments()">Add More Files</button>
                </div>
            </div>
            
            <!-- Account Information -->
            <div class="card full-width" id="accountInfoCard" style="display: none;">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    Account Information
                </h2>
                <div class="account-info" id="accountInfo"></div>
            </div>

            <!-- Summary Stats -->
            <div class="stat-grid full-width">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" id="totalIncome">$0</div>
                    <div class="stat-change" id="incomeChange">+0% from last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value" id="totalExpenses">$0</div>
                    <div class="stat-change" id="expenseChange">+0% from last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Savings</div>
                    <div class="stat-value" id="netSavings">$0</div>
                    <div class="stat-change" id="savingsRate">0% savings rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Balance</div>
                    <div class="stat-value" id="currentBalance">$0</div>
                    <div class="stat-change" id="balanceChange">+$0 this month</div>
                </div>
            </div>

            <!-- Spending by Category -->
            <div class="card">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Spending by Category
                </h2>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Monthly Trend -->
            <div class="card">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    Monthly Trend
                </h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Budget Tracking -->
            <div class="card full-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Budget vs Actual
                </h2>
                <div id="budgetContainer"></div>
            </div>

            <!-- Smart Insights -->
            <div class="card half-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Smart Insights
                </h2>
                <ul class="insights-list" id="insightsList"></ul>
            </div>

            <!-- Daily Spending -->
            <div class="card half-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Daily Spending Pattern
                </h2>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card full-width">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Recent Transactions
                </h2>
                <div class="filter-controls">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expenses</option>
                    </select>
                    <input type="date" id="startDate" placeholder="Start Date">
                    <input type="date" id="endDate" placeholder="End Date">
                </div>
                <div style="overflow-x: auto;">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Balance</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                    <button class="export-btn" onclick="generateReport()">Generate Report</button>
                    <button class="export-btn" onclick="showAllDocuments()">Show All Documents</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let transactions = [];
        let categories = {};
        let monthlyData = {};
        let budgets = {};
        let accountDetails = {};
        let uploadedDocuments = [];
        let currentDocumentIndex = 0;

        // Enhanced category detection patterns
        const categoryPatterns = {
            'Groceries': ['grocery', 'supermarket', 'walmart', 'target', 'kroger', 'safeway', 'whole foods', 'trader joe', 'woolworth', 'coles', 'aldi', 'iga'],
            'Dining': ['restaurant', 'cafe', 'coffee', 'starbucks', 'mcdonalds', 'chipotle', 'pizza', 'bar', 'pub', 'sushi', 'nandos', 'hungry jack', 'oporto', 'gong cha', 'doordash', 'uber *eat', 'menulog'],
            'Transportation': ['uber', 'lyft', 'gas', 'shell', 'chevron', 'parking', 'toll', 'transit', 'metro', 'ampol', 'mobil', 'petrol', 'fuel'],
            'Shopping': ['amazon', 'ebay', 'store', 'mall', 'clothing', 'shoes', 'fashion', 'kmart', 'target', 'bunnings', 'costco'],
            'Entertainment': ['netflix', 'spotify', 'movie', 'theater', 'concert', 'game', 'sport', 'audible', 'apple.com/bill', 'google youtube'],
            'Utilities': ['electric', 'gas', 'water', 'internet', 'phone', 'verizon', 'att', 'comcast', 'telstra', 'optus', 'vodafone'],
            'Healthcare': ['pharmacy', 'doctor', 'hospital', 'dental', 'medical', 'cvs', 'walgreens', 'bupa', 'medicare', 'health'],
            'Housing': ['rent', 'mortgage', 'property', 'lease', 'apartment', 'real estate'],
            'Insurance': ['insurance', 'geico', 'allstate', 'progressive', 'suncorp', 'aami', 'nrma'],
            'Travel': ['hotel', 'booking.com', 'airbnb', 'flight', 'airline', 'expedia', 'holiday'],
            'Subscriptions': ['subscription', 'membership', 'resmed', 'patreon', 'onlyfans'],
            'Income': ['salary', 'payroll', 'deposit', 'transfer', 'income', 'payment received', 'wages'],
            'PayPal': ['paypal', 'pypl'],
            'Savings': ['savings', 'investment', '401k', 'ira', 'transfer to savings']
        };

        // Category colors
        const categoryColors = {
            'Groceries': '#10b981',
            'Dining': '#f59e0b',
            'Transportation': '#3b82f6',
            'Shopping': '#ec4899',
            'Entertainment': '#8b5cf6',
            'Utilities': '#6b7280',
            'Healthcare': '#ef4444',
            'Housing': '#14b8a6',
            'Insurance': '#f97316',
            'Travel': '#06b6d4',
            'Subscriptions': '#a855f7',
            'Income': '#22c55e',
            'PayPal': '#0070ba',
            'Savings': '#06b6d4',
            'Other': '#9ca3af'
        };

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                processMultipleFiles(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                processMultipleFiles(files);
            }
        });

        async function processMultipleFiles(files) {
            document.getElementById('loading').classList.add('active');
            
            // Clear existing data if this is the first upload
            if (uploadedDocuments.length === 0) {
                transactions = [];
                categories = {};
                monthlyData = {};
                budgets = {};
                accountDetails = {};
            }
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            // Show processing status
            showProcessingStatus(totalFiles);
            
            for (const file of files) {
                try {
                    const documentData = {
                        name: file.name,
                        size: file.size,
                        type: file.name.endsWith('.pdf') ? 'PDF' : 'CSV',
                        uploadDate: new Date(),
                        transactions: [],
                        accountDetails: {},
                        processed: false
                    };
                    
                    if (file.name.endsWith('.pdf')) {
                        await processPDFForDocument(file, documentData);
                    } else if (file.name.endsWith('.csv')) {
                        await processCSVForDocument(file, documentData);
                    }
                    
                    uploadedDocuments.push(documentData);
                    processedCount++;
                    updateProcessingProgress(processedCount, totalFiles);
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    alert(`Error processing ${file.name}. Skipping this file.`);
                }
            }
            
            // Combine all document data
            combineDocumentData();
            
            // Hide loading and show dashboard
            setTimeout(() => {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('documentManager').style.display = 'block';
                
                // Start with combined view if multiple documents, otherwise show the single document
                if (uploadedDocuments.length > 1) {
                    currentDocumentIndex = -1;
                    combineDocumentData();
                } else {
                    currentDocumentIndex = 0;
                }
                updateDocumentManager();
            }, 1000);
        }
        
        async function processFile(file) {
            // Legacy function for backward compatibility
            await processMultipleFiles([file]);
        }

        async function processPDFForDocument(file, documentData) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                // Show extraction preview
                const preview = document.getElementById('extractionPreview');
                const content = document.getElementById('extractionContent');
                preview.style.display = 'block';
                content.textContent = fullText.substring(0, 1000) + '...';
                
                // Parse the extracted text for this document
                parsePDFTextForDocument(fullText, documentData);
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('Error processing PDF. Please try a different file.');
                document.getElementById('loading').classList.remove('active');
            }
        }

        function parsePDFTextForDocument(text, documentData) {
            const docTransactions = [];
            const docAccountDetails = {};
            
            // Extract account details (for HSBC format)
            const accountMatch = text.match(/Account Number.*?(\d{4}\s+\d{4}\s+\d{4}\s+\d{4})/);
            const creditLimitMatch = text.match(/Credit Limit\s+\$?([\d,]+\.?\d*)/);
            const closingBalanceMatch = text.match(/Closing Balance\s+\$?([\d,]+\.?\d*)/);
            const openingBalanceMatch = text.match(/Opening Balance\s+\$?([\d,]+\.?\d*)/);
            
            if (accountMatch) {
                docAccountDetails.accountNumber = accountMatch[1].replace(/\s+/g, ' ');
            }
            if (creditLimitMatch) {
                docAccountDetails.creditLimit = parseFloat(creditLimitMatch[1].replace(/,/g, ''));
            }
            if (closingBalanceMatch) {
                docAccountDetails.closingBalance = parseFloat(closingBalanceMatch[1].replace(/,/g, ''));
            }
            if (openingBalanceMatch) {
                docAccountDetails.openingBalance = parseFloat(openingBalanceMatch[1].replace(/,/g, ''));
            }
            
            // Parse transactions - looking for date patterns and amounts
            const lines = text.split('\n');
            const transactionPattern = /(\d{1,2}\/\d{2}\/\d{2,4})\s+(\d{4})?\s*(.*?)\s+(-?\$?[\d,]+\.?\d*)/;
            const altPattern = /(\d{1,2}\/\d{2}\/\d{2})\s+(.*?)\s+\$?([\d,]+\.\d{2})/;
            
            lines.forEach((line, index) => {
                if (line.length < 10) return;
                
                let match = line.match(transactionPattern);
                if (!match) {
                    match = line.match(altPattern);
                }
                
                if (match) {
                    const dateStr = match[1];
                    let description = '';
                    let amountStr = '';
                    
                    if (match.length === 5) {
                        description = match[3].trim();
                        amountStr = match[4];
                    } else {
                        description = match[2].trim();
                        amountStr = match[3];
                    }
                    
                    const amount = parseFloat(amountStr.replace(/[$,]/g, ''));
                    
                    if (!isNaN(amount) && description.length > 0) {
                        const dateParts = dateStr.split('/');
                        let date;
                        if (dateParts[2].length === 2) {
                            date = new Date(`20${dateParts[2]}`, parseInt(dateParts[1]) - 1, dateParts[0]);
                        } else {
                            date = new Date(dateParts[2], parseInt(dateParts[1]) - 1, dateParts[0]);
                        }
                        
                        const category = detectCategory(description);
                        const isRefund = description.toLowerCase().includes('refund') || 
                                       description.toLowerCase().includes('credit') ||
                                       amountStr.includes('-');
                        const type = (category === 'Income' || isRefund) ? 'income' : 'expense';
                        
                        const transaction = {
                            date,
                            description: description.substring(0, 50),
                            amount: isRefund ? Math.abs(amount) : -Math.abs(amount),
                            balance: 0,
                            category,
                            type,
                            month: date.toISOString().substring(0, 7),
                            sourceDocument: documentData.name
                        };
                        
                        docTransactions.push(transaction);
                    }
                }
            });
            
            // Sort transactions by date
            docTransactions.sort((a, b) => b.date - a.date);
            
            // Calculate running balance
            if (docAccountDetails.closingBalance) {
                let runningBalance = docAccountDetails.closingBalance;
                for (let i = 0; i < docTransactions.length; i++) {
                    docTransactions[i].balance = runningBalance;
                    runningBalance -= docTransactions[i].amount;
                }
            }
            
            documentData.transactions = docTransactions;
            documentData.accountDetails = docAccountDetails;
            documentData.processed = true;
        }
        
        function parsePDFText(text) {
            // This function is kept for backward compatibility
            const tempDocData = { transactions: [], accountDetails: {} };
            parsePDFTextForDocument(text, tempDocData);
            
            transactions = tempDocData.transactions;
            accountDetails = tempDocData.accountDetails;
            categories = {};
            monthlyData = {};
            
            // Extract account details (for HSBC format)
            const accountMatch = text.match(/Account Number.*?(\d{4}\s+\d{4}\s+\d{4}\s+\d{4})/);
            const creditLimitMatch = text.match(/Credit Limit\s+\$?([\d,]+\.?\d*)/);
            const closingBalanceMatch = text.match(/Closing Balance\s+\$?([\d,]+\.?\d*)/);
            const openingBalanceMatch = text.match(/Opening Balance\s+\$?([\d,]+\.?\d*)/);
            
            if (accountMatch) {
                accountDetails.accountNumber = accountMatch[1].replace(/\s+/g, ' ');
            }
            if (creditLimitMatch) {
                accountDetails.creditLimit = parseFloat(creditLimitMatch[1].replace(/,/g, ''));
            }
            if (closingBalanceMatch) {
                accountDetails.closingBalance = parseFloat(closingBalanceMatch[1].replace(/,/g, ''));
            }
            if (openingBalanceMatch) {
                accountDetails.openingBalance = parseFloat(openingBalanceMatch[1].replace(/,/g, ''));
            }
            
            // Update account info display
            if (Object.keys(accountDetails).length > 0) {
                updateAccountInfo();
            }
            
            // Parse transactions - looking for date patterns and amounts
            // Common patterns: DD/MM/YY or DD/MM/YYYY followed by description and amount
            const lines = text.split('\n');
            const transactionPattern = /(\d{1,2}\/\d{2}\/\d{2,4})\s+(\d{4})?\s*(.*?)\s+(-?\$?[\d,]+\.?\d*)/;
            
            // Also check for transactions in a different format
            const altPattern = /(\d{1,2}\/\d{2}\/\d{2})\s+(.*?)\s+\$?([\d,]+\.\d{2})/;
            
            lines.forEach((line, index) => {
                // Skip header lines and empty lines
                if (line.length < 10) return;
                
                // Try to match transaction patterns
                let match = line.match(transactionPattern);
                if (!match) {
                    match = line.match(altPattern);
                }
                
                if (match) {
                    const dateStr = match[1];
                    let description = '';
                    let amountStr = '';
                    
                    if (match.length === 5) {
                        // Format with card number
                        description = match[3].trim();
                        amountStr = match[4];
                    } else {
                        // Alternative format
                        description = match[2].trim();
                        amountStr = match[3];
                    }
                    
                    // Clean up amount
                    const amount = parseFloat(amountStr.replace(/[$,]/g, ''));
                    
                    if (!isNaN(amount) && description.length > 0) {
                        // Parse date
                        const dateParts = dateStr.split('/');
                        let date;
                        if (dateParts[2].length === 2) {
                            // Assume 20YY for 2-digit years
                            date = new Date(`20${dateParts[2]}`, parseInt(dateParts[1]) - 1, dateParts[0]);
                        } else {
                            date = new Date(dateParts[2], parseInt(dateParts[1]) - 1, dateParts[0]);
                        }
                        
                        // Detect category
                        const category = detectCategory(description);
                        
                        // Determine if income or expense
                        // Check for refunds/credits
                        const isRefund = description.toLowerCase().includes('refund') || 
                                       description.toLowerCase().includes('credit') ||
                                       amountStr.includes('-');
                        
                        const type = (category === 'Income' || isRefund) ? 'income' : 'expense';
                        
                        const transaction = {
                            date,
                            description: description.substring(0, 50), // Truncate long descriptions
                            amount: isRefund ? Math.abs(amount) : -Math.abs(amount),
                            balance: 0, // Will calculate running balance later
                            category,
                            type,
                            month: date.toISOString().substring(0, 7)
                        };
                        
                        transactions.push(transaction);
                        
                        // Aggregate by category
                        if (!categories[category]) {
                            categories[category] = 0;
                        }
                        if (type === 'expense') {
                            categories[category] += Math.abs(amount);
                        }
                        
                        // Aggregate by month
                        if (!monthlyData[transaction.month]) {
                            monthlyData[transaction.month] = {
                                income: 0,
                                expenses: 0,
                                transactions: []
                            };
                        }
                        
                        if (type === 'income') {
                            monthlyData[transaction.month].income += Math.abs(amount);
                        } else {
                            monthlyData[transaction.month].expenses += Math.abs(amount);
                        }
                        monthlyData[transaction.month].transactions.push(transaction);
                    }
                }
            });
            
            // Sort transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Calculate running balance
            if (accountDetails.closingBalance) {
                let runningBalance = accountDetails.closingBalance;
                for (let i = 0; i < transactions.length; i++) {
                    transactions[i].balance = runningBalance;
                    runningBalance -= transactions[i].amount;
                }
            }
            
            // Generate budgets based on spending
            generateBudgets();
            
            // Update UI
            updateStats();
            updateCharts();
            updateTransactionsTable();
            updateBudgetView();
            generateInsights();
            updateFilters();
        }

        async function processCSVForDocument(file, documentData) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        try {
                            processTransactionsForDocument(results.data, documentData);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        function processCSV(file) {
            // Legacy function for backward compatibility
            processCSVForDocument(file, { transactions: [], accountDetails: {} })
                .then(() => {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                });
        }

        function detectCategory(description) {
            const desc = description.toLowerCase();
            for (const [category, patterns] of Object.entries(categoryPatterns)) {
                if (patterns.some(pattern => desc.includes(pattern))) {
                    return category;
                }
            }
            return 'Other';
        }

        function processTransactionsForDocument(data, documentData) {
            const docTransactions = [];
            
            // Process each transaction
            data.forEach(row => {
                if (!row.Date && !row.date) return;
                
                const date = new Date(row.Date || row.date);
                const description = row.Description || row.description || row.Payee || '';
                const amount = parseFloat(row.Amount || row.amount || row.Debit || row.Credit || 0);
                const balance = parseFloat(row.Balance || row.balance || 0);
                
                if (isNaN(amount)) return;

                const category = detectCategory(description);
                const type = amount > 0 ? 'income' : 'expense';
                
                const transaction = {
                    date,
                    description,
                    amount,
                    balance,
                    category,
                    type,
                    month: date.toISOString().substring(0, 7),
                    sourceDocument: documentData.name
                };
                
                docTransactions.push(transaction);
            });

            // Sort transactions by date
            docTransactions.sort((a, b) => b.date - a.date);
            
            documentData.transactions = docTransactions;
            documentData.processed = true;
        }
        
        function processTransactions(data) {
            // This function is kept for backward compatibility
            const tempDocData = { transactions: [] };
            processTransactionsForDocument(data, tempDocData);
            
            transactions = tempDocData.transactions;
            categories = {};
            monthlyData = {};

            // Process each transaction
            data.forEach(row => {
                if (!row.Date && !row.date) return;
                
                const date = new Date(row.Date || row.date);
                const description = row.Description || row.description || row.Payee || '';
                const amount = parseFloat(row.Amount || row.amount || row.Debit || row.Credit || 0);
                const balance = parseFloat(row.Balance || row.balance || 0);
                
                if (isNaN(amount)) return;

                const category = detectCategory(description);
                const type = amount > 0 ? 'income' : 'expense';
                
                const transaction = {
                    date,
                    description,
                    amount,
                    balance,
                    category,
                    type,
                    month: date.toISOString().substring(0, 7)
                };
                
                transactions.push(transaction);
                
                // Aggregate by category
                if (!categories[category]) {
                    categories[category] = 0;
                }
                if (type === 'expense') {
                    categories[category] += Math.abs(amount);
                }
                
                // Aggregate by month
                if (!monthlyData[transaction.month]) {
                    monthlyData[transaction.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (type === 'income') {
                    monthlyData[transaction.month].income += amount;
                } else {
                    monthlyData[transaction.month].expenses += Math.abs(amount);
                }
                monthlyData[transaction.month].transactions.push(transaction);
            });

            // Sort transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Generate budgets based on spending
            generateBudgets();
            
            // Update UI
            updateStats();
            updateCharts();
            updateTransactionsTable();
            updateBudgetView();
            generateInsights();
            updateFilters();
        }

        function updateAccountInfo() {
            const card = document.getElementById('accountInfoCard');
            const container = document.getElementById('accountInfo');
            
            if (Object.keys(accountDetails).length > 0) {
                card.style.display = 'block';
                container.innerHTML = '';
                
                if (accountDetails.accountNumber) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Account Number</span>
                            <span class="account-info-value">****${accountDetails.accountNumber.slice(-4)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.creditLimit) {
                    const availableCredit = accountDetails.creditLimit - (accountDetails.closingBalance || 0);
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Credit Limit</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.creditLimit)}</span>
                        </div>
                        <div class="account-info-item">
                            <span class="account-info-label">Available Credit</span>
                            <span class="account-info-value">${formatCurrency(availableCredit)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.openingBalance) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Opening Balance</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.openingBalance)}</span>
                        </div>
                    `;
                }
                
                if (accountDetails.closingBalance) {
                    container.innerHTML += `
                        <div class="account-info-item">
                            <span class="account-info-label">Closing Balance</span>
                            <span class="account-info-value">${formatCurrency(accountDetails.closingBalance)}</span>
                        </div>
                    `;
                }
            }
        }

        function generateBudgets() {
            // Create suggested budgets based on average spending
            Object.keys(categories).forEach(category => {
                if (category !== 'Income' && category !== 'Savings') {
                    budgets[category] = Math.ceil(categories[category] * 1.1); // 10% buffer
                }
            });
        }

        function updateStats() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().substring(0, 7);
            
            // Get all months of data
            const allMonths = Object.keys(monthlyData).sort();
            const latestMonth = allMonths[allMonths.length - 1] || currentMonth;
            const previousMonth = allMonths[allMonths.length - 2] || lastMonth;
            
            const currentMonthData = monthlyData[latestMonth] || { income: 0, expenses: 0 };
            const lastMonthData = monthlyData[previousMonth] || { income: 0, expenses: 0 };
            
            const totalIncome = currentMonthData.income;
            const totalExpenses = currentMonthData.expenses;
            const netSavings = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? (netSavings / totalIncome * 100) : 0;
            
            const currentBalance = accountDetails.closingBalance || (transactions.length > 0 ? transactions[0].balance : 0);
            const monthStartBalance = accountDetails.openingBalance || (transactions.find(t => t.month !== latestMonth)?.balance || 0);
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netSavings').textContent = formatCurrency(netSavings);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
            
            // Calculate changes
            const incomeChange = lastMonthData.income > 0 ? 
                ((totalIncome - lastMonthData.income) / lastMonthData.income * 100) : 0;
            const expenseChange = lastMonthData.expenses > 0 ? 
                ((totalExpenses - lastMonthData.expenses) / lastMonthData.expenses * 100) : 0;
            
            document.getElementById('incomeChange').textContent = 
                `${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}% from last month`;
            document.getElementById('expenseChange').textContent = 
                `${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}% from last month`;
            document.getElementById('savingsRate').textContent = 
                `${savingsRate.toFixed(1)}% savings rate`;
            document.getElementById('balanceChange').textContent = 
                `${currentBalance - monthStartBalance >= 0 ? '+' : ''}${formatCurrency(currentBalance - monthStartBalance)} this month`;
        }

        function updateCharts() {
            // Destroy existing charts if they exist
            const charts = ['categoryChart', 'trendChart', 'dailyChart'];
            charts.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas.chart) {
                    canvas.chart.destroy();
                }
            });
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = Object.entries(categories)
                .filter(([cat, _]) => cat !== 'Income' && cat !== 'Savings')
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            categoryCtx.canvas.chart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(([cat, _]) => cat),
                    datasets: [{
                        data: categoryData.map(([_, amount]) => amount),
                        backgroundColor: categoryData.map(([cat, _]) => categoryColors[cat] || categoryColors['Other'])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const months = Object.keys(monthlyData).sort().slice(-6);
            
            trendCtx.canvas.chart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: months.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: months.map(m => monthlyData[m].income),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Expenses',
                        data: months.map(m => monthlyData[m].expenses),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
            
            // Daily Spending Chart
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const dailySpending = {};
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const day = daysOfWeek[t.date.getDay()];
                    dailySpending[day] = (dailySpending[day] || 0) + Math.abs(t.amount);
                }
            });
            
            dailyCtx.canvas.chart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: daysOfWeek,
                    datasets: [{
                        label: 'Average Daily Spending',
                        data: daysOfWeek.map(day => dailySpending[day] || 0),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBudgetView() {
            const budgetContainer = document.getElementById('budgetContainer');
            budgetContainer.innerHTML = '';
            
            Object.entries(budgets).forEach(([category, budget]) => {
                const spent = categories[category] || 0;
                const percentage = Math.min((spent / budget * 100), 100);
                const remaining = budget - spent;
                
                const budgetItem = document.createElement('div');
                budgetItem.className = 'budget-item';
                budgetItem.innerHTML = `
                    <div class="budget-label">${category}</div>
                    <div class="budget-bar">
                        <div class="budget-fill" style="width: ${percentage}%; background: ${percentage > 90 ? '#ef4444' : percentage > 75 ? '#f59e0b' : 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)'}">
                            ${percentage.toFixed(0)}%
                        </div>
                    </div>
                    <div class="budget-amount">
                        ${formatCurrency(spent)} / ${formatCurrency(budget)}
                    </div>
                `;
                budgetContainer.appendChild(budgetItem);
            });
        }

        function generateInsights() {
            const insights = [];
            const allMonths = Object.keys(monthlyData).sort();
            const latestMonth = allMonths[allMonths.length - 1];
            const currentMonthData = monthlyData[latestMonth] || { income: 0, expenses: 0 };
            
            // Biggest spending category
            const biggestCategory = Object.entries(categories)
                .filter(([cat, _]) => cat !== 'Income' && cat !== 'Savings')
                .sort((a, b) => b[1] - a[1])[0];
            
            if (biggestCategory) {
                insights.push(`ðŸ’¡ Your biggest spending category is ${biggestCategory[0]} at ${formatCurrency(biggestCategory[1])} this period.`);
            }
            
            // Savings rate insight
            const savingsRate = currentMonthData.income > 0 ? 
                ((currentMonthData.income - currentMonthData.expenses) / currentMonthData.income * 100) : 0;
            
            if (savingsRate > 20) {
                insights.push(`ðŸŽ‰ Great job! You're saving ${savingsRate.toFixed(1)}% of your income.`);
            } else if (savingsRate > 0) {
                insights.push(`ðŸ“Š You're saving ${savingsRate.toFixed(1)}% of your income. Consider aiming for 20% or more.`);
            } else {
                insights.push(`âš ï¸ You're spending more than you earn. Time to review your budget.`);
            }
            
            // Credit utilization for credit cards
            if (accountDetails.creditLimit && accountDetails.closingBalance) {
                const utilization = (accountDetails.closingBalance / accountDetails.creditLimit * 100);
                if (utilization > 30) {
                    insights.push(`ðŸ’³ Your credit utilization is ${utilization.toFixed(1)}%. Consider keeping it below 30% for better credit score.`);
                } else {
                    insights.push(`âœ… Good credit utilization at ${utilization.toFixed(1)}%. Keeping it below 30% helps your credit score.`);
                }
            }
            
            // Unusual spending detection
            const avgDailySpending = currentMonthData.expenses / 30;
            const highSpendingDays = transactions.filter(t => 
                t.type === 'expense' && Math.abs(t.amount) > avgDailySpending * 3
            );
            
            if (highSpendingDays.length > 0) {
                insights.push(`ðŸ“ˆ You had ${highSpendingDays.length} high spending transactions over ${formatCurrency(avgDailySpending * 3)}.`);
            }
            
            // Most frequent merchant
            const merchantFrequency = {};
            transactions.forEach(t => {
                if (t.type === 'expense') {
                    const merchant = t.description.split(' ')[0];
                    merchantFrequency[merchant] = (merchantFrequency[merchant] || 0) + 1;
                }
            });
            
            const topMerchant = Object.entries(merchantFrequency)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topMerchant && topMerchant[1] > 3) {
                insights.push(`ðŸ›ï¸ You visited ${topMerchant[0]} ${topMerchant[1]} times. Is this a regular expense you can optimize?`);
            }
            
            // PayPal/subscription spending
            const paypalSpending = categories['PayPal'] || 0;
            const subscriptionSpending = categories['Subscriptions'] || 0;
            if (paypalSpending + subscriptionSpending > currentMonthData.expenses * 0.15) {
                insights.push(`ðŸ’» Online/subscription spending is ${((paypalSpending + subscriptionSpending) / currentMonthData.expenses * 100).toFixed(1)}% of your expenses. Review recurring charges.`);
            }
            
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions.slice(0, 50).forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.date.toLocaleDateString()}</td>
                    <td>${t.description}</td>
                    <td><span class="category-badge" style="background: ${categoryColors[t.category]}20; color: ${categoryColors[t.category]}">${t.category}</span></td>
                    <td class="${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">${formatCurrency(Math.abs(t.amount))}</td>
                    <td>${t.balance ? formatCurrency(t.balance) : '-'}</td>
                    <td style="font-size: 0.8em; color: #6b7280;">${t.sourceDocument || 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            const uniqueCategories = [...new Set(transactions.map(t => t.category))];
            
            uniqueCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // Add filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
            document.getElementById('startDate').addEventListener('change', filterTransactions);
            document.getElementById('endDate').addEventListener('change', filterTransactions);
        }

        function filterTransactions() {
            const category = document.getElementById('categoryFilter').value;
            const type = document.getElementById('typeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filtered = transactions;
            
            if (category) {
                filtered = filtered.filter(t => t.category === category);
            }
            
            if (type) {
                filtered = filtered.filter(t => t.type === type);
            }
            
            if (startDate) {
                filtered = filtered.filter(t => t.date >= new Date(startDate));
            }
            
            if (endDate) {
                filtered = filtered.filter(t => t.date <= new Date(endDate));
            }
            
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            filtered.slice(0, 50).forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.date.toLocaleDateString()}</td>
                    <td>${t.description}</td>
                    <td><span class="category-badge" style="background: ${categoryColors[t.category]}20; color: ${categoryColors[t.category]}">${t.category}</span></td>
                    <td class="${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">${formatCurrency(Math.abs(t.amount))}</td>
                    <td>${t.balance ? formatCurrency(t.balance) : '-'}</td>
                    <td style="font-size: 0.8em; color: #6b7280;">${t.sourceDocument || 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(Math.abs(amount));
        }

        function showProcessingStatus(totalFiles) {
            const dashboard = document.getElementById('dashboard');
            const existingStatus = document.getElementById('processingStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.id = 'processingStatus';
            statusDiv.className = 'processing-status';
            statusDiv.innerHTML = `
                <div>
                    <strong>Processing ${totalFiles} file(s)...</strong>
                    <div id="processingText">Starting...</div>
                </div>
                <div class="processing-progress">
                    <div class="processing-progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            `;
            
            dashboard.insertBefore(statusDiv, dashboard.firstChild);
        }
        
        function updateProcessingProgress(processed, total) {
            const progressBar = document.getElementById('progressBar');
            const processingText = document.getElementById('processingText');
            
            if (progressBar && processingText) {
                const percentage = (processed / total) * 100;
                progressBar.style.width = `${percentage}%`;
                processingText.textContent = `Processed ${processed} of ${total} files`;
                
                if (processed === total) {
                    processingText.textContent = 'Combining data from all documents...';
                    setTimeout(() => {
                        const statusDiv = document.getElementById('processingStatus');
                        if (statusDiv) {
                            statusDiv.remove();
                        }
                    }, 1000);
                }
            }
        }
        
        function combineDocumentData() {
            transactions = [];
            categories = {};
            monthlyData = {};
            accountDetails = {};
            
            // Combine all transactions from all documents
            uploadedDocuments.forEach(doc => {
                if (doc.processed && doc.transactions) {
                    transactions.push(...doc.transactions);
                }
                
                // Merge account details (prefer the most complete one)
                if (doc.accountDetails && Object.keys(doc.accountDetails).length > Object.keys(accountDetails).length) {
                    accountDetails = { ...accountDetails, ...doc.accountDetails };
                }
            });
            
            // Sort all transactions by date
            transactions.sort((a, b) => b.date - a.date);
            
            // Recalculate categories and monthly data
            transactions.forEach(t => {
                // Aggregate by category
                if (!categories[t.category]) {
                    categories[t.category] = 0;
                }
                if (t.type === 'expense') {
                    categories[t.category] += Math.abs(t.amount);
                }
                
                // Aggregate by month
                if (!monthlyData[t.month]) {
                    monthlyData[t.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (t.type === 'income') {
                    monthlyData[t.month].income += Math.abs(t.amount);
                } else {
                    monthlyData[t.month].expenses += Math.abs(t.amount);
                }
                monthlyData[t.month].transactions.push(t);
            });
            
            // Generate budgets and update UI
            generateBudgets();
            updateStats();
            updateCharts();
            updateTransactionsTable();
            updateBudgetView();
            generateInsights();
            updateFilters();
            
            if (Object.keys(accountDetails).length > 0) {
                updateAccountInfo();
            }
        }
        
        function updateDocumentManager() {
            const documentList = document.getElementById('documentList');
            const documentCount = document.getElementById('documentCount');
            
            documentCount.textContent = uploadedDocuments.length;
            documentList.innerHTML = '';
            
            // Add "All Documents" option if we have multiple documents
            if (uploadedDocuments.length > 1) {
                const allDocsItem = document.createElement('div');
                allDocsItem.className = `document-item ${currentDocumentIndex === -1 ? 'active' : ''}`;
                allDocsItem.innerHTML = `
                    <div class="document-name" onclick="showAllDocuments()">ðŸ“Š All Documents Combined</div>
                    <div class="document-stats">
                        Combined view â€¢ ${transactions.length} total transactions
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="showAllDocuments()">View Combined</button>
                    </div>
                `;
                documentList.appendChild(allDocsItem);
            }
            
            uploadedDocuments.forEach((doc, index) => {
                const docItem = document.createElement('div');
                docItem.className = `document-item ${index === currentDocumentIndex ? 'active' : ''}`;
                docItem.innerHTML = `
                    <div class="document-name" onclick="viewDocument(${index})">${doc.name}</div>
                    <div class="document-stats">
                        ${doc.type} â€¢ ${(doc.size / 1024).toFixed(1)} KB â€¢ ${doc.transactions?.length || 0} transactions
                    </div>
                    <div class="document-actions">
                        <button class="document-btn view" onclick="viewDocument(${index})">View</button>
                        <button class="document-btn remove" onclick="removeDocument(${index})">Remove</button>
                    </div>
                `;
                documentList.appendChild(docItem);
            });
        }
        
        function viewDocument(index) {
            currentDocumentIndex = index;
            const doc = uploadedDocuments[index];
            
            // Update UI to show only this document's data
            transactions = [...doc.transactions];
            accountDetails = { ...doc.accountDetails };
            
            // Recalculate stats for this document only
            categories = {};
            monthlyData = {};
            
            transactions.forEach(t => {
                if (!categories[t.category]) {
                    categories[t.category] = 0;
                }
                if (t.type === 'expense') {
                    categories[t.category] += Math.abs(t.amount);
                }
                
                if (!monthlyData[t.month]) {
                    monthlyData[t.month] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }
                
                if (t.type === 'income') {
                    monthlyData[t.month].income += Math.abs(t.amount);
                } else {
                    monthlyData[t.month].expenses += Math.abs(t.amount);
                }
                monthlyData[t.month].transactions.push(t);
            });
            
            generateBudgets();
            updateStats();
            updateCharts();
            updateTransactionsTable();
            updateBudgetView();
            generateInsights();
            updateFilters();
            updateAccountInfo();
            updateDocumentManager();
        }
        
        function removeDocument(index) {
            if (confirm(`Are you sure you want to remove "${uploadedDocuments[index].name}"?`)) {
                uploadedDocuments.splice(index, 1);
                
                if (uploadedDocuments.length === 0) {
                    // Reset everything
                    transactions = [];
                    categories = {};
                    monthlyData = {};
                    budgets = {};
                    accountDetails = {};
                    document.getElementById('uploadSection').style.display = 'block';
                    document.getElementById('dashboard').classList.remove('active');
                } else {
                    // Recombine remaining documents
                    combineDocumentData();
                    updateDocumentManager();
                }
            }
        }
        
        function clearAllDocuments() {
            if (confirm('Are you sure you want to remove all documents and start over?')) {
                uploadedDocuments = [];
                transactions = [];
                categories = {};
                monthlyData = {};
                budgets = {};
                accountDetails = {};
                currentDocumentIndex = 0;
                
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('documentManager').style.display = 'none';
            }
        }
        
        function addMoreDocuments() {
            document.getElementById('fileInput').click();
        }
        
        function showAllDocuments() {
            currentDocumentIndex = -1; // -1 indicates "all documents" view
            combineDocumentData();
            updateDocumentManager();
        }
        
        function loadSampleData() {
            const sampleData = generateSampleData();
            
            // Create a mock document for sample data
            const sampleDoc = {
                name: 'Sample_Bank_Statement.csv',
                size: 50000,
                type: 'CSV',
                uploadDate: new Date(),
                transactions: [],
                accountDetails: {},
                processed: false
            };
            
            processTransactionsForDocument(sampleData, sampleDoc);
            
            uploadedDocuments = [sampleDoc];
            currentDocumentIndex = -1; // Start with "all documents" view
            combineDocumentData();
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('documentManager').style.display = 'block';
            updateDocumentManager();
        }

        function generateSampleData() {
            const data = [];
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3);
            let balance = 5000;
            
            const sampleTransactions = [
                { desc: 'Salary Deposit', amount: 5000, cat: 'Income' },
                { desc: 'Woolworths Supermarket', amount: -156.32, cat: 'Groceries' },
                { desc: 'Netflix Subscription', amount: -15.99, cat: 'Entertainment' },
                { desc: 'Ampol Petrol Station', amount: -45.00, cat: 'Transportation' },
                { desc: 'Starbucks Coffee', amount: -5.75, cat: 'Dining' },
                { desc: 'Amazon Marketplace AU', amount: -89.99, cat: 'Shopping' },
                { desc: 'Energy Australia', amount: -120.00, cat: 'Utilities' },
                { desc: 'Rent Payment', amount: -1500.00, cat: 'Housing' },
                { desc: 'Nandos Restaurant', amount: -42.50, cat: 'Dining' },
                { desc: 'Kmart Store', amount: -67.43, cat: 'Shopping' },
                { desc: 'Uber Ride', amount: -18.50, cat: 'Transportation' },
                { desc: 'Chemist Warehouse', amount: -25.00, cat: 'Healthcare' },
                { desc: 'Freelance Payment', amount: 1200.00, cat: 'Income' },
                { desc: 'Spotify Premium', amount: -9.99, cat: 'Entertainment' },
                { desc: 'Coles Supermarket', amount: -98.76, cat: 'Groceries' },
                { desc: 'BP Service Station', amount: -40.00, cat: 'Transportation' },
                { desc: 'Sushi Train', amount: -45.00, cat: 'Dining' },
                { desc: 'AAMI Insurance', amount: -150.00, cat: 'Insurance' },
                { desc: 'Anytime Fitness', amount: -50.00, cat: 'Healthcare' },
                { desc: 'Telstra Mobile', amount: -60.00, cat: 'Utilities' },
                { desc: 'PayPal Transfer', amount: -125.00, cat: 'PayPal' },
                { desc: 'Bunnings Warehouse', amount: -89.95, cat: 'Shopping' },
                { desc: 'DoorDash Delivery', amount: -32.45, cat: 'Dining' }
            ];
            
            for (let i = 0; i < 90; i++) {
                const transaction = sampleTransactions[Math.floor(Math.random() * sampleTransactions.length)];
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                
                balance += transaction.amount;
                
                data.push({
                    Date: date.toISOString().split('T')[0],
                    Description: transaction.desc,
                    Amount: transaction.amount,
                    Balance: balance
                });
            }
            
            return data.reverse();
        }

        function exportToCSV() {
            const csvContent = Papa.unparse(transactions.map(t => ({
                Date: t.date.toISOString().split('T')[0],
                Description: t.description,
                Category: t.category,
                Amount: t.amount,
                Balance: t.balance,
                Type: t.type
            })));
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_report.csv';
            a.click();
        }

        function generateReport() {
            const report = {
                summary: {
                    totalTransactions: transactions.length,
                    categories: Object.keys(categories).length,
                    dateRange: transactions.length > 0 ? 
                        `${transactions[transactions.length - 1].date.toLocaleDateString()} - ${transactions[0].date.toLocaleDateString()}` : 
                        'No data',
                    ...accountDetails
                },
                monthlyBreakdown: monthlyData,
                categoryBreakdown: categories,
                insights: document.getElementById('insightsList').innerText
            };
            
            const reportJson = JSON.stringify(report, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_report.json';
            a.click();
            
            alert('Financial report generated! The report includes your transaction summary, monthly breakdown, category analysis, and personalized insights.');
        }
    </script>
</body>
</html>